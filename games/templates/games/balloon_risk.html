{% extends 'base.html' %}

{% block title %}Balloon Risk Game - Rasmetric{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
  <div class="max-w-4xl mx-auto px-4 py-8">
    <button
      onclick="window.location.href='{% url 'game_list' %}'"
      class="flex items-center text-gray-600 hover:text-gray-900 mb-6"
    >
      <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg>
      Back to Games
    </button>

    <div id="gameContainer" class="text-center">
      <h2 class="text-2xl font-bold text-gray-900 mb-4">Balloon Risk Game</h2>
      <div class="bg-white rounded-lg shadow-sm p-8 mb-6">
        <div class="flex justify-between items-center mb-6">
          <div>
            <p class="text-sm text-gray-600">Round: <span id="roundDisplay">1</span>/10</p>
            <p class="text-sm text-gray-600">Score: <span id="scoreDisplay">0</span></p>
            <p class="text-sm text-gray-600">Pumps: <span id="pumpCountDisplay">0</span>/<span id="maxPumpsDisplay">30</span></p>
          </div>
          <div class="text-right">
            <p class="text-sm text-gray-600">Size: <span id="balloonSizeDisplay">50</span></p>
          </div>
        </div>

        <div class="mb-8">
          <div 
            id="balloon"
            class="mx-auto bg-red-400 rounded-full transition-all duration-300"
            style="width: 50px; height: 50px; max-width: 200px; max-height: 200px;"
          ></div>
        </div>

        <div class="flex justify-center space-x-4">
          <button
            id="inflateButton"
            onclick="inflateBalloon()"
            class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700"
          >
            Inflate (+10)
          </button>
          <button
            id="cashOutButton"
            onclick="cashOut()"
            class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700"
          >
            Cash Out (+<span id="cashOutValue">25</span>)
          </button>
        </div>
      </div>
    </div>

    <div id="gameOverContainer" class="text-center hidden">
      <h2 class="text-2xl font-bold text-gray-900 mb-4">Game Complete!</h2>
      <div class="bg-blue-50 rounded-lg p-6 mb-6">
        <p class="text-lg text-gray-700 mb-2">Your Final Score: <span id="finalScore" class="font-bold text-blue-600">0</span></p>
        <p class="text-sm text-gray-600">Rounds Completed: <span id="finalRounds">0</span></p>
      </div>
      <button
        onclick="window.location.href='{% url 'game_list' %}'"
        class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700"
      >
        Continue
      </button>
    </div>
  </div>
</div>

<script>
let balloonSize = 50;
let score = 0;
let round = 1;
let gameOver = false;
let burstPoint = 0;
let pumpCount = 0;
const MAX_PUMPS = 15;
const PUMP_SIZE = 10;
let decisions = [];
let reactionTimes = [];
let startTime = Date.now();
let roundStartTime = Date.now();

function initGame() {
  setBurstPoint();
  updateDisplay();
}

function setBurstPoint() {
  burstPoint = Math.floor(Math.random() * MAX_PUMPS) + 1;
  pumpCount = 0;
  balloonSize = 50;
  roundStartTime = Date.now();
}

function updateDisplay() {
  document.getElementById('roundDisplay').textContent = round;
  document.getElementById('scoreDisplay').textContent = score;
  document.getElementById('pumpCountDisplay').textContent = pumpCount;
  document.getElementById('maxPumpsDisplay').textContent = MAX_PUMPS;
  document.getElementById('balloonSizeDisplay').textContent = balloonSize;
  const balloon = document.getElementById('balloon');
  balloon.style.width = balloonSize + 'px';
  balloon.style.height = balloonSize + 'px';
}

function inflateBalloon() {
  const reactionTime = Date.now() - roundStartTime;
  reactionTimes.push(reactionTime);
  pumpCount += 1;
  balloonSize = 50 + pumpCount * PUMP_SIZE;
  updateDisplay();
  if (pumpCount >= burstPoint) {
    // Balloon bursts
    decisions.push({
      round: round,
      action: 'inflate',
      pumpCount: pumpCount,
      burstPoint: burstPoint,
      outcome: 'burst'
    });
    if (round >= 10) {
      endGame();
    } else {
      round++;
      setBurstPoint();
      updateDisplay();
    }
  } else {
    decisions.push({
      round: round,
      action: 'inflate',
      pumpCount: pumpCount,
      burstPoint: burstPoint,
      outcome: 'continue'
    });
  }
}

function cashOut() {
  const reactionTime = Date.now() - roundStartTime;
  reactionTimes.push(reactionTime);
  const roundScore = pumpCount;
  score += roundScore;
  decisions.push({
    round: round,
    action: 'cash_out',
    pumpCount: pumpCount,
    burstPoint: burstPoint,
    outcome: 'cash_out',
    points: roundScore
  });
  if (round >= 10) {
    endGame();
  } else {
    round++;
    setBurstPoint();
    updateDisplay();
  }
}

function endGame() {
  gameOver = true;
  const totalTime = Date.now() - startTime;
  document.getElementById('gameContainer').classList.add('hidden');
  document.getElementById('gameOverContainer').classList.remove('hidden');
  document.getElementById('finalScore').textContent = Math.min(score, 100);
  document.getElementById('finalRounds').textContent = round;
  saveGameResult(totalTime);
}

function saveGameResult(totalTime) {
  const gameData = {
    game_type: 'balloon_risk',
    score: Math.min(score, 100),
    duration: totalTime,
    decisions: decisions,
    reaction_times: reactionTimes,
    raw_data: {
      total_rounds: round,
      average_reaction_time: reactionTimes.reduce((a, b) => a + b, 0) / reactionTimes.length,
      risk_tolerance: decisions.filter(d => d.action === 'inflate').length / decisions.length
    }
  };
  fetch('{% url "games:save_game_result" %}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    },
    body: JSON.stringify(gameData)
  })
  .then(response => response.json())
  .then(data => {
    console.log('Game result saved:', data);
  })
  .catch(error => {
    console.error('Error saving game result:', error);
  });
}
document.addEventListener('DOMContentLoaded', function() {
  initGame();
});
</script>

{% csrf_token %}
{% endblock %} 