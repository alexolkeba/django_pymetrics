{% extends 'base.html' %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
    :root {
        --primary-color: #38BDF8; /* Light Blue 400 */
        --success-color: #34D399; /* Green 400 */
        --danger-color: #F87171; /* Red 400 */
        --warning-color: #FBBF24; /* Amber 400 */
        --background-color: #0F172A; /* Slate 900 */
        --surface-color: #1E293B; /* Slate 800 */
        --text-color: #F1F5F9; /* Slate 100 */
        --muted-text-color: #94A3B8; /* Slate 400 */
        --border-color: #334155; /* Slate 700 */
    }
    .game-body { background-color: var(--background-color); color: var(--text-color); font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 1rem; }
    .game-container { background-color: var(--surface-color); border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3); width: 100%; max-width: 800px; overflow: hidden; }
    .game-header { background-color: rgba(0,0,0,0.2); padding: 1.5rem; text-align: center; border-bottom: 1px solid var(--border-color); }
    .game-header h2 { font-size: 1.75rem; font-weight: bold; margin: 0; }
    .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; padding: 1.5rem; border-bottom: 1px solid var(--border-color); }
    .stat-card { background-color: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px; text-align: center; }
    .stat-card .value { font-size: 1.75rem; font-weight: bold; color: var(--primary-color); }
    .stat-card .label { font-size: 0.8rem; color: var(--muted-text-color); text-transform: uppercase; font-weight: 600; }
    .game-area { padding: 2rem; min-height: 400px; display: flex; flex-direction: column; justify-content: space-between; align-items: center; }
    .balloon-wrapper { flex-grow: 1; display: flex; justify-content: center; align-items: center; width: 100%; margin-bottom: 2rem; }
    #balloon { transition: transform 0.2s ease-out, filter 0.2s; cursor: pointer; }
    #balloon.pumping { animation: pump-anim 0.3s ease-in-out; }
    @keyframes pump-anim { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    #balloon.burst { animation: burst-anim 0.5s forwards; }
    @keyframes burst-anim { 0% { transform: scale(1), rotate(0deg); opacity: 1; } 100% { transform: scale(2.5) rotate(45deg); opacity: 0; } }
    .game-controls { display: flex; gap: 1rem; width: 100%; justify-content: center; }
    .btn { padding: 0.75rem 2rem; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: all 0.2s; color: var(--text-color); display: flex; align-items: center; gap: 0.5rem; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    #pump-btn { background-color: var(--primary-color); }
    #cash-out-btn { background-color: var(--success-color); }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); justify-content: center; align-items: center; }
    .modal-content { background-color: var(--surface-color); padding: 2.5rem; border-radius: 12px; border: 1px solid var(--border-color); max-width: 500px; width: 90%; box-shadow: 0 5px 15px rgba(0,0,0,0.5); animation: modal-pop 0.3s ease-out; text-align: center; }
    @keyframes modal-pop { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    #back-to-games-btn { position: absolute; top: 20px; left: 20px; background-color: rgba(0, 0, 0, 0.3); color: var(--text-color); padding: 0.5rem 1rem; border-radius: 8px; text-decoration: none; font-weight: bold; z-index: 10; }
</style>

<div class="game-body" data-game-list-url="{% url 'games:game_list' %}" data-csrf-token="{{ csrf_token }}">
    <a href="#" id="back-to-games-btn"><i class="fas fa-arrow-left"></i> Back to Games</a>

    <div class="game-container">
        <div class="game-header"><h2>Adaptive Risk Challenge</h2></div>
        <div class="dashboard">
            <div class="stat-card"><div id="total-winnings" class="value">$0</div><div class="label">Total Winnings</div></div>
            <div class="stat-card"><div id="potential-winnings" class="value">$0</div><div class="label">Potential Gain</div></div>
            <div class="stat-card"><div id="risk-level" class="value">Low</div><div class="label">Risk Level</div></div>
            <div class="stat-card"><div id="round-counter" class="value">-</div><div class="label">Round</div></div>
        </div>

        <div class="game-area">
            <div class="balloon-wrapper">
                <svg id="balloon" viewBox="0 0 100 120" width="100">
                    <defs>
                        <radialGradient id="balloon-gradient" cx="30%" cy="30%" r="70%" fx="30%" fy="30%">
                            <stop offset="0%" stop-color="#A3E635" />
                            <stop offset="100%" stop-color="#4D7C0F" />
                        </radialGradient>
                    </defs>
                    <path d="M50,115 C10,90 10,60 50,20 C90,60 90,90 50,115 Z" fill="url(#balloon-gradient)"/>
                    <path d="M45,115 Q50,120 55,115" stroke="#334155" stroke-width="2" fill="none" />
                </svg>
            </div>
            <div class="game-controls">
                <button id="pump-btn" class="btn"><i class="fas fa-pump-soap"></i> Pump</button>
                <button id="cash-out-btn" class="btn"><i class="fas fa-piggy-bank"></i> Cash Out</button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="instruction-modal" class="modal" style="display: flex;">
        <div class="modal-content">
            <h3 style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color);">Welcome to the Adaptive Risk Challenge!</h3>
            <p style="margin: 1rem 0;">Your goal is to earn as much money as possible over 30 rounds. In each round, pump the balloon to increase its value. The more you pump, the more you can earn, but the risk of it bursting also increases. The game adapts to your playstyle. Cash out to secure your earnings before it pops!</p>
            <button id="start-game-btn" class="btn">Start Game</button>
        </div>
    </div>
    <div id="final-results-modal" class="modal">
        <div class="modal-content">
            <h3 style="font-size: 1.5rem; font-weight: bold;">Challenge Complete!</h3>
            <div id="final-summary" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem 1rem; text-align: left; margin: 1.5rem auto; width: fit-content;"></div>
            <button id="return-to-games-final-btn" class="btn">Return to Games</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- CONFIGURATION ---
    const GAME_ID = 'balloon_risk';
    const TOTAL_ROUNDS = 30;
    const BASE_PUMP_VALUE = 5;
    const INITIAL_BURST_PROBABILITY_GROWTH = 0.01;
    const MIN_BURST_PROBABILITY_GROWTH = 0.005;
    const MAX_BURST_PROBABILITY_GROWTH = 0.03;
    const PROBABILITY_ADJUSTMENT_FACTOR = 0.001;

    // --- DOM Elements ---
    const gameBody = document.querySelector('.game-body');
    const pumpBtn = document.getElementById('pump-btn');
    const cashOutBtn = document.getElementById('cash-out-btn');
    const balloon = document.getElementById('balloon');
    const totalWinningsEl = document.getElementById('total-winnings');
    const potentialWinningsEl = document.getElementById('potential-winnings');
    const riskLevelEl = document.getElementById('risk-level');
    const roundCounterEl = document.getElementById('round-counter');
    const instructionModal = document.getElementById('instruction-modal');
    const finalResultsModal = document.getElementById('final-results-modal');
    const startGameBtn = document.getElementById('start-game-btn');
    const returnToGamesFinalBtn = document.getElementById('return-to-games-final-btn');
    const backToGamesBtn = document.getElementById('back-to-games-btn');

    // --- GAME STATE ---
    let currentRound = 0;
    let totalWinnings = 0;
    let potentialWinnings = 0;
    let pumpsThisRound = 0;
    let burstProbability = 0;
    let burstProbabilityGrowth = INITIAL_BURST_PROBABILITY_GROWTH;
    let events = [];
    let gameStartTime = 0;
    let roundStartTime = 0;
    let gameCompleted = false;

    // --- Core Game Logic ---
    const startGame = () => {
        gameStartTime = Date.now();
        instructionModal.style.display = 'none';
        logEvent('game_start');
        startRound();
    };

    const startRound = () => {
        currentRound++;
        if (currentRound > TOTAL_ROUNDS) {
            endGame(true);
            return;
        }
        pumpsThisRound = 0;
        potentialWinnings = 0;
        burstProbability = 0;
        roundStartTime = Date.now();
        updateUI();
        setControls(true);
        balloon.style.transform = 'scale(1)';
        balloon.classList.remove('burst');
        logEvent('round_start');
    };

    const pumpBalloon = () => {
        pumpsThisRound++;
        potentialWinnings += BASE_PUMP_VALUE;
        burstProbability += burstProbabilityGrowth;
        
        balloon.style.transform = `scale(${1 + pumpsThisRound * 0.05})`;
        balloon.classList.add('pumping');
        setTimeout(() => balloon.classList.remove('pumping'), 200);

        logEvent('pump');

        if (Math.random() < burstProbability) {
            handleBurst();
        } else {
            updateUI();
        }
    };

    const cashOut = () => {
        totalWinnings += potentialWinnings;
        logEvent('cash_out');
        // ADAPTIVE LOGIC: If player cashes out, slightly decrease risk for next round (encourage more pumps)
        burstProbabilityGrowth = Math.max(MIN_BURST_PROBABILITY_GROWTH, burstProbabilityGrowth - PROBABILITY_ADJUSTMENT_FACTOR);
        setControls(false);
        setTimeout(startRound, 1000);
    };

    const handleBurst = () => {
        potentialWinnings = 0;
        logEvent('burst');
        // ADAPTIVE LOGIC: If balloon bursts, slightly increase risk for next round (discourage risky behavior)
        burstProbabilityGrowth = Math.min(MAX_BURST_PROBABILITY_GROWTH, burstProbabilityGrowth + PROBABILITY_ADJUSTMENT_FACTOR * 2);
        setControls(false);
        balloon.classList.add('burst');
        setTimeout(startRound, 1500);
    };

    const endGame = (completed) => {
        gameCompleted = completed;
        setControls(false);
        displayFinalResults();
        finalResultsModal.style.display = 'flex';
        sendDataToBackend();
    };

    // --- UI & Controls ---
    const updateUI = () => {
        totalWinningsEl.textContent = `$${totalWinnings}`;
        potentialWinningsEl.textContent = `$${potentialWinnings}`;
        roundCounterEl.textContent = `${currentRound}/${TOTAL_ROUNDS}`;
        
        if (burstProbability < 0.33) riskLevelEl.textContent = 'Low';
        else if (burstProbability < 0.66) riskLevelEl.textContent = 'Medium';
        else riskLevelEl.textContent = 'High';
        riskLevelEl.style.color = burstProbability < 0.33 ? 'var(--success-color)' : (burstProbability < 0.66 ? 'var(--warning-color)' : 'var(--danger-color)');

        cashOutBtn.disabled = pumpsThisRound === 0;
    };

    const setControls = (enabled) => {
        pumpBtn.disabled = !enabled;
        cashOutBtn.disabled = !enabled || pumpsThisRound === 0;
    };

    const displayFinalResults = () => {
        const totalPumps = events.filter(e => e.action === 'pump').length;
        const totalBursts = events.filter(e => e.action === 'burst').length;
        const totalCashedOut = events.filter(e => e.action === 'cash_out').length;
        const avgPumpsPerRound = totalCashedOut > 0 ? (events.filter(e => e.action === 'pump' && e.potential_winnings > 0).length / totalCashedOut) : 0;

        const summaryEl = document.getElementById('final-summary');
        summaryEl.innerHTML = `
            <div><strong>Total Winnings:</strong></div><div style="color: var(--success-color); font-weight: bold;">$${totalWinnings}</div>
            <div><strong>Rounds Played:</strong></div><div>${currentRound - 1}/${TOTAL_ROUNDS}</div>
            <div><strong>Balloons Popped:</strong></div><div>${totalBursts}</div>
            <div><strong>Successful Cash-outs:</strong></div><div>${totalCashedOut}</div>
            <div><strong>Avg. Pumps (Cashed Out):</strong></div><div>${avgPumpsPerRound.toFixed(2)}</div>
        `;
    };

    // --- Data Handling ---
    const logEvent = (action) => {
        const event = {
            round: currentRound,
            action: action,
            pumps_this_round: pumpsThisRound,
            potential_winnings: potentialWinnings,
            total_winnings: totalWinnings,
            burst_probability: burstProbability.toFixed(4),
            burst_probability_growth: burstProbabilityGrowth.toFixed(4),
            timestamp: Date.now() - gameStartTime,
        };
        events.push(event);
    };

    const sendDataToBackend = () => {
        const completionStatus = gameCompleted ? 'completed' : 'abandoned';
        const totalDuration = Date.now() - gameStartTime;
        const totalPumps = events.filter(e => e.action === 'pump').length;
        const totalBursts = events.filter(e => e.action === 'burst').length;

        const data = {
            game_name: GAME_ID,
            score: totalWinnings,
            duration_ms: totalDuration,
            completion_status: completionStatus,
            events: events,
            game_specific_data: {
                total_pumps: totalPumps,
                total_bursts: totalBursts,
                total_cash_outs: events.filter(e => e.action === 'cash_out').length,
                final_burst_probability_growth: burstProbabilityGrowth,
                avg_pumps_per_round: totalPumps / (currentRound > 1 ? currentRound - 1 : 1)
            }
        };

        return fetch('{% url "games:save_score" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': gameBody.dataset.csrfToken,
            },
            body: JSON.stringify(data),
        });
    };

    const quitGame = () => {
        if (gameStartTime === 0) {
            window.location.href = gameBody.dataset.gameListUrl;
            return;
        }
        if (finalResultsModal.style.display === 'flex') {
             window.location.href = gameBody.dataset.gameListUrl;
             return;
        }
        gameCompleted = false;
        sendDataToBackend().finally(() => {
            window.location.href = gameBody.dataset.gameListUrl;
        });
    };

    // --- Event Listeners ---
    startGameBtn.addEventListener('click', startGame);
    pumpBtn.addEventListener('click', pumpBalloon);
    cashOutBtn.addEventListener('click', cashOut);
    backToGamesBtn.addEventListener('click', (e) => { e.preventDefault(); quitGame(); });
    returnToGamesFinalBtn.addEventListener('click', (e) => { e.preventDefault(); window.location.href = gameBody.dataset.gameListUrl; });
});
</script>
{% endblock %}
