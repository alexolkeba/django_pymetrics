{% extends 'base.html' %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
    :root {
        --primary-color: #60A5FA; /* Blue-400 */
        --go-color: #34D399;      /* Green-400 */
        --wait-color: #F87171;    /* Red-400 */
        --background-color: #0F172A; /* Slate-900 */
        --surface-color: #1E293B;   /* Slate-800 */
        --text-color: #F1F5F9;       /* Slate-100 */
        --muted-text-color: #94A3B8; /* Slate-400 */
        --border-color: #334155;     /* Slate-700 */
    }
    .game-body { background-color: var(--background-color); color: var(--text-color); font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 1rem; }
    .game-container { background-color: var(--surface-color); border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3); width: 100%; max-width: 800px; overflow: hidden; }
    .game-header { background-color: rgba(0,0,0,0.2); padding: 1.5rem; text-align: center; border-bottom: 1px solid var(--border-color); }
    .game-header h2 { font-size: 1.75rem; font-weight: bold; margin: 0; }
    .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; padding: 1.5rem; border-bottom: 1px solid var(--border-color); }
    .stat-card { background-color: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px; text-align: center; }
    .stat-card .value { font-size: 1.5rem; font-weight: bold; color: var(--primary-color); }
    .stat-card .label { font-size: 0.8rem; color: var(--muted-text-color); text-transform: uppercase; font-weight: 600; }
    .game-area { padding: 2rem; min-height: 350px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    #stimulus-box {
        width: 100%; height: 250px; border-radius: 12px; cursor: pointer; display: flex; justify-content: center; align-items: center;
        font-size: 2.5rem; font-weight: bold; text-align: center; transition: background-color 0.2s, color 0.2s;
    }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); justify-content: center; align-items: center; }
    .modal-content { background-color: var(--surface-color); padding: 2.5rem; border-radius: 12px; border: 1px solid var(--border-color); max-width: 500px; width: 90%; box-shadow: 0 5px 15px rgba(0,0,0,0.5); animation: modal-pop 0.3s ease-out; text-align: center; }
    @keyframes modal-pop { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .btn { padding: 0.75rem 2rem; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: all 0.2s; color: var(--background-color); background-color: var(--primary-color); }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(96, 165, 250, 0.3); }
    #back-to-games-btn { position: absolute; top: 20px; left: 20px; background-color: rgba(0, 0, 0, 0.3); color: var(--text-color); padding: 0.5rem 1rem; border-radius: 8px; text-decoration: none; font-weight: bold; z-index: 10; }
</style>

<div class="game-body" data-game-list-url="{% url 'games:game_list' %}" data-csrf-token="{{ csrf_token }}">
    <a href="#" id="back-to-games-btn"><i class="fas fa-arrow-left"></i> Back to Games</a>

    <div class="game-container">
        <div class="game-header"><h2>Temporal Reflex Challenge</h2></div>
        <div class="dashboard">
            <div class="stat-card"><div id="trial-count" class="value">-</div><div class="label">Trial</div></div>
            <div class="stat-card"><div id="avg-rt" class="value">-</div><div class="label">Avg. Reaction</div></div>
            <div class="stat-card"><div id="last-rt" class="value">-</div><div class="label">Last Reaction</div></div>
            <div class="stat-card"><div id="early-clicks" class="value">0</div><div class="label">Early Clicks</div></div>
        </div>
        <div class="game-area">
            <div id="stimulus-box"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="instruction-modal" class="modal" style="display: flex;">
        <div class="modal-content">
            <h3 style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color);">Temporal Reflex Challenge</h3>
            <p style="margin: 1rem 0; color: var(--muted-text-color);">Test your reaction time. When the box turns green, click it or press the spacebar as fast as you can.</p>
            <p style="font-weight: bold;">Do NOT click or press before it turns green!</p>
            <button id="start-game-btn" class="btn" style="margin-top: 1.5rem;">Begin</button>
        </div>
    </div>

    <div id="final-results-modal" class="modal">
        <div class="modal-content">
            <h3 style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color);">Challenge Complete!</h3>
            <div id="final-summary" style="margin: 1.5rem 0; font-size: 1.1rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;"></div>
            <button id="return-to-games-final-btn" class="btn">Return to Games</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const elements = {
            body: document.querySelector('.game-body'),
            stimulusBox: document.getElementById('stimulus-box'),
            instructionModal: document.getElementById('instruction-modal'),
            finalResultsModal: document.getElementById('final-results-modal'),
            startGameBtn: document.getElementById('start-game-btn'),
            backToGamesBtn: document.getElementById('back-to-games-btn'),
            returnToGamesFinalBtn: document.getElementById('return-to-games-final-btn'),
            trialCount: document.getElementById('trial-count'),
            avgRt: document.getElementById('avg-rt'),
            lastRt: document.getElementById('last-rt'),
            earlyClicks: document.getElementById('early-clicks'),
            finalSummary: document.getElementById('final-summary'),
        };

        // --- Game Configuration ---
        const config = {
            TOTAL_TRIALS: 20,
            MIN_DELAY: 1500, // ms
            MAX_DELAY: 4000, // ms
        };

        // --- Game State ---
        let state = {
            gameState: 'instructions', // instructions, waiting, ready, go, finished
            currentTrial: 0,
            events: [],
            validReactions: [],
            earlyClickCount: 0,
            startTime: null,
            gameStartTime: null,
            timeoutId: null,
            isSaving: false,
        };

        // --- Utility Functions ---
        const getCsrfToken = () => elements.body.dataset.csrfToken;
        const getGameListUrl = () => elements.body.dataset.gameListUrl;

        // --- UI Update Functions ---
        const updateDashboard = () => {
            elements.trialCount.textContent = `${state.currentTrial}/${config.TOTAL_TRIALS}`;
            elements.earlyClicks.textContent = state.earlyClickCount;

            const lastValidReaction = state.validReactions.length > 0 ? state.validReactions[state.validReactions.length - 1] : null;
            elements.lastRt.textContent = lastValidReaction ? `${Math.round(lastValidReaction)}ms` : '-';

            if (state.validReactions.length > 0) {
                const avg = state.validReactions.reduce((a, b) => a + b, 0) / state.validReactions.length;
                elements.avgRt.textContent = `${Math.round(avg)}ms`;
            } else {
                elements.avgRt.textContent = '-';
            }
        };

        const setStimulusState = (mode, text) => {
            const box = elements.stimulusBox;
            box.textContent = text;
            box.style.color = 'var(--text-color)';
            if (mode === 'waiting') box.style.backgroundColor = 'var(--surface-color)';
            if (mode === 'ready') box.style.backgroundColor = 'var(--wait-color)';
            if (mode === 'go') box.style.backgroundColor = 'var(--go-color)';
            if (mode === 'feedback') {
                box.style.backgroundColor = 'var(--primary-color)';
                box.style.color = 'var(--background-color)';
            }
        };

        // --- Game Logic ---
        const startTrial = () => {
            if (state.gameState === 'finished') return;

            state.currentTrial++;
            updateDashboard();
            state.gameState = 'ready';
            setStimulusState('ready', 'Wait...');

            const delay = Math.random() * (config.MAX_DELAY - config.MIN_DELAY) + config.MIN_DELAY;
            state.timeoutId = setTimeout(() => {
                if (state.gameState !== 'ready') return; // Aborted by early click
                state.gameState = 'go';
                state.startTime = performance.now();
                setStimulusState('go', 'GO!');
            }, delay);

            state.events.push({ type: 'trial_start', trial: state.currentTrial, timestamp: performance.now(), delay: delay });
        };

        const handleReaction = () => {
            if (state.gameState === 'go') {
                const reactionTime = performance.now() - state.startTime;
                state.validReactions.push(reactionTime);
                state.events.push({ type: 'reaction', trial: state.currentTrial, outcome: 'valid', reaction_time: reactionTime, timestamp: performance.now() });
                setStimulusState('feedback', `${Math.round(reactionTime)}ms`);
            } else if (state.gameState === 'ready') {
                clearTimeout(state.timeoutId);
                state.earlyClickCount++;
                state.events.push({ type: 'reaction', trial: state.currentTrial, outcome: 'early', timestamp: performance.now() });
                setStimulusState('feedback', 'Too Early!');
            }

            updateDashboard();
            state.gameState = 'waiting';

            setTimeout(() => {
                if (state.currentTrial >= config.TOTAL_TRIALS) {
                    endGame(true); // Completed naturally
                } else {
                    startTrial();
                }
            }, 1200); // Feedback display time
        };

        const showFinalResults = () => {
            const avgRT = state.validReactions.length > 0 ? state.validReactions.reduce((a, b) => a + b, 0) / state.validReactions.length : 0;
            const score = Math.max(0, 1000 - Math.round(avgRT) - (state.earlyClickCount * 50));
            const accuracy = config.TOTAL_TRIALS > 0 ? (state.validReactions.length / config.TOTAL_TRIALS) * 100 : 0;

            elements.finalSummary.innerHTML = `
                <div><strong>Score:</strong></div><div>${score}</div>
                <div><strong>Avg. Reaction:</strong></div><div>${Math.round(avgRT)}ms</div>
                <div><strong>Valid Reactions:</strong></div><div>${state.validReactions.length} / ${config.TOTAL_TRIALS}</div>
                <div><strong>Accuracy:</strong></div><div>${accuracy.toFixed(1)}%</div>
                <div><strong>Early Clicks:</strong></div><div>${state.earlyClickCount}</div>
            `;
            elements.finalResultsModal.style.display = 'flex';
        };

        const sendEventsToBackend = async (isCompleted) => {
            if (state.isSaving) return;
            state.isSaving = true;

            const duration = performance.now() - state.gameStartTime;
            const avgRT = state.validReactions.length > 0 ? state.validReactions.reduce((a, b) => a + b, 0) / state.validReactions.length : 0;
            const score = Math.max(0, 1000 - Math.round(avgRT) - (state.earlyClickCount * 50));

            const payload = {
                game_name: 'temporal_reflex_challenge',
                score: score,
                duration_ms: Math.round(duration),
                events: state.events,
                completion_status: isCompleted ? 'completed' : 'abandoned',
                raw_data: {
                    total_trials: config.TOTAL_TRIALS,
                    valid_reactions: state.validReactions.length,
                    early_clicks: state.earlyClickCount,
                    average_reaction_time_ms: avgRT,
                },
            };

            try {
                const response = await fetch('/games/save-score/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
                    body: JSON.stringify(payload),
                });
                if (!response.ok) throw new Error('Server responded with an error');
                return await response.json();
            } catch (error) {
                console.error('Failed to save game data:', error);
                return null; // Indicate failure
            }
        };

        const endGame = async (isCompleted) => {
            if (state.gameState === 'finished') return;
            state.gameState = 'finished';
            clearTimeout(state.timeoutId);

            state.events.push({ type: 'game_end', timestamp: performance.now(), completed: isCompleted });
            
            if (isCompleted) {
                showFinalResults();
            }
            
            await sendEventsToBackend(isCompleted);
            
            if (!isCompleted) {
                window.location.href = getGameListUrl();
            }
        };

        const quitGame = async () => {
            if (state.gameState !== 'finished') {
                await endGame(false); // Mark as abandoned
            }
        };

        // --- Event Listeners ---
        elements.startGameBtn.addEventListener('click', () => {
            elements.instructionModal.style.display = 'none';
            state.gameStartTime = performance.now();
            state.events.push({ type: 'game_start', timestamp: state.gameStartTime });
            startTrial();
        });

        elements.stimulusBox.addEventListener('click', handleReaction);
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && (state.gameState === 'ready' || state.gameState === 'go')) {
                e.preventDefault();
                handleReaction();
            }
        });

        elements.backToGamesBtn.addEventListener('click', (e) => {
            e.preventDefault();
            quitGame();
        });

        elements.returnToGamesFinalBtn.addEventListener('click', () => {
            window.location.href = getGameListUrl();
        });

        // Initialize
        setStimulusState('waiting', 'Get Ready');
        updateDashboard();
    });
</script>
{% endblock %}