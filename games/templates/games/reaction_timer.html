{% extends 'base.html' %}

{% block title %}Reaction Timer Game - Rasmetric{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
  <div class="max-w-4xl mx-auto px-4 py-8">
    <button
      onclick="window.location.href='{% url 'games:game_list' %}'"
      class="flex items-center text-gray-600 hover:text-gray-900 mb-6"
    >
      <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg>
      Back to Games
    </button>

    <div id="gameContainer" class="text-center">
      <h2 class="text-2xl font-bold text-gray-900 mb-4">Reaction Timer</h2>
      <div class="bg-white rounded-lg shadow-sm p-8 mb-6">
        <div class="mb-6">
          <p class="text-sm text-gray-600">Round: <span id="roundDisplay">1</span>/10</p>
        </div>
        <div 
          id="reactionBox"
          class="h-64 w-full rounded-lg cursor-pointer transition-all duration-300 flex items-center justify-center text-2xl font-bold bg-gray-300 text-gray-600"
          onclick="handleClick()"
        >
          Get Ready...
        </div>
        <p class="text-sm text-gray-600 mt-4">
          Click as soon as the color changes to green!
        </p>
      </div>
    </div>

    <div id="gameOverContainer" class="text-center hidden">
      <h2 class="text-2xl font-bold text-gray-900 mb-4">Game Complete!</h2>
      <div class="bg-blue-50 rounded-lg p-6 mb-6">
        <p class="text-lg text-gray-700 mb-2">Average Reaction Time: <span id="finalAvg" class="font-bold text-blue-600">0</span>ms</p>
        <p class="text-lg text-gray-700 mb-2">Valid Clicks: <span id="finalValid" class="font-bold text-blue-600">0</span>/10</p>
        <p class="text-sm text-gray-600">Score: <span id="finalScore">0</span></p>
      </div>
      <button
        onclick="window.location.href='{% url 'games:game_list' %}'"
        class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700"
      >
        Continue
      </button>
    </div>
  </div>
</div>

<script>
let gameState = 'waiting';
let reactionTimes = [];
let currentRound = 1;
let startTime = 0;
let gameStartTime = Date.now();
let decisions = [];
const totalRounds = 10;
let delayTimeout = null;
let readyTimeout = null;

function setGameState(state) {
  gameState = state;
  const box = document.getElementById('reactionBox');
  if (state === 'waiting') {
    box.className = 'h-64 w-full rounded-lg cursor-pointer transition-all duration-300 flex items-center justify-center text-2xl font-bold bg-gray-300 text-gray-600';
    box.textContent = 'Get Ready...';
    readyTimeout = setTimeout(() => {
      setGameState('ready');
      const delay = Math.random() * 3000 + 2000;
      delayTimeout = setTimeout(() => {
        setGameState('go');
        startTime = Date.now();
      }, delay);
    }, 1000);
  } else if (state === 'ready') {
    box.className = 'h-64 w-full rounded-lg cursor-pointer transition-all duration-300 flex items-center justify-center text-2xl font-bold bg-red-500 text-white';
    box.textContent = 'Wait for GREEN!';
  } else if (state === 'go') {
    box.className = 'h-64 w-full rounded-lg cursor-pointer transition-all duration-300 flex items-center justify-center text-2xl font-bold bg-green-500 text-white';
    box.textContent = 'CLICK NOW!';
  } else if (state === 'clicked') {
    box.className = 'h-64 w-full rounded-lg cursor-pointer transition-all duration-300 flex items-center justify-center text-2xl font-bold bg-blue-500 text-white';
    // Text will be set in handleClick
  }
}

function handleClick() {
  if (gameState === 'go') {
    const reactionTime = Date.now() - startTime;
    reactionTimes.push(reactionTime);
    decisions.push({
      round: currentRound,
      reactionTime: reactionTime,
      valid: true
    });
    setGameState('clicked');
    document.getElementById('reactionBox').textContent = reactionTime + 'ms';
    setTimeout(() => {
      if (currentRound < totalRounds) {
        currentRound++;
        document.getElementById('roundDisplay').textContent = currentRound;
        setGameState('waiting');
      } else {
        endGame();
      }
    }, 1000);
  } else if (gameState === 'ready') {
    // Early click penalty
    decisions.push({
      round: currentRound,
      reactionTime: null,
      valid: false,
      penalty: 'early_click'
    });
    setGameState('clicked');
    document.getElementById('reactionBox').textContent = 'Too Early!';
    setTimeout(() => {
      if (currentRound < totalRounds) {
        currentRound++;
        document.getElementById('roundDisplay').textContent = currentRound;
        setGameState('waiting');
      } else {
        endGame();
      }
    }, 1000);
  }
}

function endGame() {
  gameState = 'finished';
  document.getElementById('gameContainer').classList.add('hidden');
  document.getElementById('gameOverContainer').classList.remove('hidden');
  const averageReactionTime = reactionTimes.length > 0 ? reactionTimes.reduce((a, b) => a + b, 0) / reactionTimes.length : 1000;
  document.getElementById('finalAvg').textContent = Math.round(averageReactionTime);
  document.getElementById('finalValid').textContent = reactionTimes.length;
  const score = Math.max(0, 100 - Math.round(averageReactionTime / 10));
  document.getElementById('finalScore').textContent = score;
  saveGameResult(score, averageReactionTime);
}

function saveGameResult(score, averageReactionTime) {
  const totalTime = Date.now() - gameStartTime;
  const gameData = {
    game_type: 'reaction_timer',
    score: score,
    duration: totalTime,
    decisions: decisions,
    reaction_times: reactionTimes,
    raw_data: {
      averageReactionTime: averageReactionTime,
      validClicks: reactionTimes.length,
      totalRounds: totalRounds,
      accuracy: reactionTimes.length / totalRounds
    }
  };
  fetch('{% url "games:save_game_result" %}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    },
    body: JSON.stringify(gameData)
  })
  .then(response => response.json())
  .then(data => {
    console.log('Game result saved:', data);
  })
  .catch(error => {
    console.error('Error saving game result:', error);
  });
}

document.addEventListener('DOMContentLoaded', function() {
  setGameState('waiting');
});
</script>

{% csrf_token %}
{% endblock %} 