{% extends 'base.html' %}
{% block content %}
<div class="max-w-lg mx-auto mt-4">
    <button id="back-to-games" class="inline-block mb-4 px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300">‚Üê Back to Games</button>
</div>
<div class="game-container max-w-lg mx-auto mt-8 p-6 bg-white rounded shadow">
    <h2 class="text-2xl font-bold mb-2">Keypresses Game</h2>
    <p class="mb-4">Press the spacebar as many times as you can in <span id="duration">10</span> seconds. Try to maximize your keypress count!</p>
    <div id="game-area">
        <div class="mb-2">Current keypresses: <span id="score">0</span></div>
        <button id="start-btn" class="bg-blue-500 text-white px-4 py-2 rounded">Start</button>
        <div id="feedback" class="mt-3 text-blue-600 font-semibold"></div>
    </div>

</div>
<script>
const GAME_DURATION = 10; // seconds
let score = 0;
let events = [];
let difficulty = 'medium';
let startTime = null;
let interval = null;
let running = false;

function logEvent(type, data) {
    events.push({
        event_type: type,
        score: score,
        difficulty: difficulty,
        timestamp: Date.now(),
        ...data
    });
}

function updateUI() {
    document.getElementById('score').textContent = score;
    document.getElementById('feedback').textContent = '';
}

document.getElementById('start-btn').onclick = function() {
    if (running) return;
    running = true;
    score = 0;
    events = [];
    updateUI();
    document.getElementById('feedback').textContent = 'Go! Press the spacebar!';
    startTime = Date.now();
    logEvent('start', {});
    window.addEventListener('keydown', keyHandler);
    interval = setTimeout(endGame, GAME_DURATION * 1000);
};

function keyHandler(e) {
    if (!running) return;
    if (e.code === 'Space') {
        score++;
        logEvent('keypress', {reaction_time: Date.now() - startTime, key: 'Space'});
        updateUI();
    }
}

function endGame() {
    running = false;
    window.removeEventListener('keydown', keyHandler);
    document.getElementById('feedback').textContent = `Game Over! Final keypresses: ${score}`;
    logEvent('end', {final_score: score});
    sendEventsToBackend();
}

document.getElementById('back-to-games').onclick = function() {
    // If game is running, stop it first
    if (running) {
        clearTimeout(interval);
        running = false;
        window.removeEventListener('keydown', keyHandler);
        document.getElementById('start-btn').disabled = true;
        document.getElementById('game-area').innerHTML = `<div class='font-bold text-lg text-red-600'>Session Ended! Final keypresses: ${score}</div>`;
        logEvent('manual_end', {final_score: score});
        // Save data and then redirect
        sendEventsToBackend().then(() => {
            window.location.href = '/games/';
        }).catch(() => {
            // Even if save fails, still redirect
            window.location.href = '/games/';
        });
    } else {
        document.getElementById('start-btn').disabled = true;
        document.getElementById('game-area').innerHTML = `<div class='font-bold text-lg text-red-600'>Session Ended! Final keypresses: ${score}</div>`;
        logEvent('manual_end', {final_score: score});
        // Save data and then redirect
        sendEventsToBackend().then(() => {
            window.location.href = '/games/';
        }).catch(() => {
            // Even if save fails, still redirect
            window.location.href = '/games/';
        });
    }
};

function sendEventsToBackend() {
    return fetch('/games/save_game_result/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            game_type: 'keypresses',
            score: score,
            duration: GAME_DURATION,
            decisions: events.filter(e => e.event_type === 'keypress'),
            reaction_times: events.filter(e => e.event_type === 'keypress').map(e => e.reaction_time),
            raw_data: {events: events}
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            console.log('Session saved successfully');
        } else {
            console.error('Error saving session: ' + data.error);
        }
        return data;
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

updateUI();
</script>
{% endblock %}
