{% extends 'base.html' %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
    :root {
        --primary-color: #818CF8; /* Indigo 400 */
        --success-color: #34D399; /* Green 400 */
        --danger-color: #F87171; /* Red 400 */
        --background-color: #0F172A; /* Slate 900 */
        --surface-color: #1E293B; /* Slate 800 */
        --text-color: #F1F5F9; /* Slate 100 */
        --muted-text-color: #94A3B8; /* Slate 400 */
        --border-color: #334155; /* Slate 700 */
    }
    .game-body { background-color: var(--background-color); color: var(--text-color); font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 1rem; }
    .game-container { background-color: var(--surface-color); border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3); width: 100%; max-width: 900px; overflow: hidden; }
    .game-header { background-color: rgba(0,0,0,0.2); padding: 1.5rem; text-align: center; border-bottom: 1px solid var(--border-color); }
    .game-header h2 { font-size: 1.75rem; font-weight: bold; margin: 0; }
    .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; padding: 1.5rem; border-bottom: 1px solid var(--border-color); }
    .stat-card { background-color: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px; text-align: center; }
    .stat-card .value { font-size: 1.75rem; font-weight: bold; color: var(--primary-color); }
    .stat-card .label { font-size: 0.8rem; color: var(--muted-text-color); text-transform: uppercase; font-weight: 600; }
    .game-area { padding: 2rem; min-height: 350px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
    .choice-container { display: flex; justify-content: space-around; align-items: center; width: 100%; margin-top: 2rem; }
    .choice-btn { background-color: var(--surface-color); border: 2px solid var(--border-color); color: var(--text-color); font-size: 3rem; font-weight: bold; width: 200px; height: 200px; border-radius: 12px; cursor: pointer; transition: all 0.2s ease; display: flex; justify-content: center; align-items: center; }
    .choice-btn:hover { background-color: var(--primary-color); border-color: var(--primary-color); }
    .feedback { font-size: 1.5rem; font-weight: bold; margin-top: 1rem; height: 30px; }
    .correct { color: var(--success-color); }
    .incorrect { color: var(--danger-color); }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); justify-content: center; align-items: center; }
    .modal-content { background-color: var(--surface-color); padding: 2.5rem; border-radius: 12px; border: 1px solid var(--border-color); max-width: 500px; width: 90%; box-shadow: 0 5px 15px rgba(0,0,0,0.5); animation: modal-pop 0.3s ease-out; text-align: center; }
    @keyframes modal-pop { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    #back-to-games-btn { position: absolute; top: 20px; left: 20px; background-color: rgba(0, 0, 0, 0.3); color: var(--text-color); padding: 0.5rem 1rem; border-radius: 8px; text-decoration: none; font-weight: bold; z-index: 10; }
</style>

<div class="game-body" data-game-list-url="{% url 'games:game_list' %}" data-csrf-token="{{ csrf_token }}">
    <a href="#" id="back-to-games-btn"><i class="fas fa-arrow-left"></i> Back to Games</a>

    <div class="game-container">
        <div class="game-header"><h2>Numerical Acuity Challenge</h2></div>
        <div class="dashboard">
            <div class="stat-card"><div id="accuracy" class="value">100%</div><div class="label">Accuracy</div></div>
            <div class="stat-card"><div id="difficulty" class="value">-</div><div class="label">Difference</div></div>
            <div class="stat-card"><div id="trial-counter" class="value">-</div><div class="label">Trial</div></div>
        </div>

        <div class="game-area">
            <p style="font-size: 1.25rem;">Which number is larger?</p>
            <div class="choice-container">
                <button id="choice-1" class="choice-btn"></button>
                <button id="choice-2" class="choice-btn"></button>
            </div>
            <div id="feedback" class="feedback"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="instruction-modal" class="modal" style="display: flex;">
        <div class="modal-content">
            <h3 style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color);">Welcome to the Numerical Acuity Challenge!</h3>
            <p style="margin: 1rem 0;">In each trial, you will see two numbers. Your task is to choose the larger number as quickly and accurately as possible. The difficulty will adapt based on your performance. The challenge consists of 40 trials.</p>
            <button id="start-game-btn" class="btn">Start Challenge</button>
        </div>
    </div>
    <div id="final-results-modal" class="modal">
        <div class="modal-content">
            <h3 style="font-size: 1.5rem; font-weight: bold;">Challenge Complete!</h3>
            <div id="final-summary" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem 1rem; text-align: left; margin: 1.5rem auto; width: fit-content;"></div>
            <button id="return-to-games-final-btn" class="btn">Return to Games</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- CONFIGURATION ---
    const GAME_ID = 'magnitudes';
    const TOTAL_TRIALS = 40;
    const BASE_NUMBER = 50;
    const INITIAL_DIFFERENCE = 15;
    const MIN_DIFFERENCE = 1;
    const STAIRCASE_UP_COUNT = 3; // 3 correct in a row to decrease difference
    const STAIRCASE_DOWN_COUNT = 1; // 1 incorrect to increase difference

    // --- DOM Elements ---
    const gameBody = document.querySelector('.game-body');
    const { instructionModal, finalResultsModal, choice1Btn, choice2Btn, feedbackEl } = {
        instructionModal: document.getElementById('instruction-modal'),
        finalResultsModal: document.getElementById('final-results-modal'),
        choice1Btn: document.getElementById('choice-1'),
        choice2Btn: document.getElementById('choice-2'),
        feedbackEl: document.getElementById('feedback'),
    };
    const { accuracyEl, difficultyEl, trialCounterEl } = {
        accuracyEl: document.getElementById('accuracy'),
        difficultyEl: document.getElementById('difficulty'),
        trialCounterEl: document.getElementById('trial-counter'),
    };
    const { startGameBtn, backToGamesBtn, returnToGamesFinalBtn } = {
        startGameBtn: document.getElementById('start-game-btn'),
        backToGamesBtn: document.getElementById('back-to-games-btn'),
        returnToGamesFinalBtn: document.getElementById('return-to-games-final-btn'),
    };

    // --- GAME STATE ---
    let state = {};
    const resetState = () => {
        state = {
            currentTrial: 0,
            correctCount: 0,
            currentDifference: INITIAL_DIFFERENCE,
            correctStreak: 0,
            incorrectStreak: 0, // Not used for staircase, but for potential future logic
            events: [],
            gameStartTime: 0,
            trialStartTime: 0,
            gameCompleted: false,
            currentCorrectValue: 0,
        };
    };

    // --- Core Game Logic ---
    const startGame = () => {
        resetState();
        state.gameStartTime = Date.now();
        instructionModal.style.display = 'none';
        logEvent('game_start');
        nextTrial();
    };

    const nextTrial = () => {
        state.currentTrial++;
        if (state.currentTrial > TOTAL_TRIALS) {
            endGame(true);
            return;
        }

        feedbackEl.textContent = '';
        [choice1Btn, choice2Btn].forEach(btn => btn.disabled = false);
        updateDashboard();

        const num1 = BASE_NUMBER;
        const num2 = BASE_NUMBER + state.currentDifference;
        state.currentCorrectValue = num2;

        const isNum1Left = Math.random() < 0.5;
        choice1Btn.textContent = isNum1Left ? num1 : num2;
        choice2Btn.textContent = isNum1Left ? num2 : num1;

        state.trialStartTime = Date.now();
        logEvent('trial_start', { num1: num1, num2: num2, difference: state.currentDifference });
    };

    const handleChoice = (chosenValue) => {
        [choice1Btn, choice2Btn].forEach(btn => btn.disabled = true);
        const reactionTime = Date.now() - state.trialStartTime;
        const isCorrect = chosenValue === state.currentCorrectValue;

        if (isCorrect) {
            state.correctCount++;
            state.correctStreak++;
            feedbackEl.textContent = 'Correct!';
            feedbackEl.className = 'feedback correct';
            if (state.correctStreak >= STAIRCASE_UP_COUNT) {
                state.currentDifference = Math.max(MIN_DIFFERENCE, state.currentDifference - 1);
                state.correctStreak = 0;
            }
        } else {
            state.correctStreak = 0;
            feedbackEl.textContent = 'Incorrect';
            feedbackEl.className = 'feedback incorrect';
            state.currentDifference = Math.min(INITIAL_DIFFERENCE, state.currentDifference + 2);
        }

        logEvent('trial_end', { choice: chosenValue, correct_value: state.currentCorrectValue, is_correct: isCorrect, reaction_time: reactionTime });

        setTimeout(nextTrial, 1200);
    };

    const endGame = (completed) => {
        state.gameCompleted = completed;
        displayFinalResults();
        finalResultsModal.style.display = 'flex';
        sendDataToBackend();
    };

    // --- UI & Helpers ---
    const updateDashboard = () => {
        const accuracy = state.currentTrial > 1 ? (state.correctCount / (state.currentTrial - 1) * 100).toFixed(0) : 100;
        accuracyEl.textContent = `${accuracy}%`;
        difficultyEl.textContent = state.currentDifference;
        trialCounterEl.textContent = `${state.currentTrial}/${TOTAL_TRIALS}`;
    };

    const displayFinalResults = () => {
        const avgReactionTime = state.events.filter(e => e.type === 'trial_end').reduce((acc, e) => acc + e.reaction_time, 0) / (state.events.filter(e => e.type === 'trial_end').length || 1);
        const finalAccuracy = (state.correctCount / TOTAL_TRIALS * 100).toFixed(1);
        document.getElementById('final-summary').innerHTML = `
            <div><strong>Final Accuracy:</strong></div><div style="color: var(--success-color); font-weight: bold;">${finalAccuracy}%</div>
            <div><strong>Final Difference (JND):</strong></div><div>${state.currentDifference}</div>
            <div><strong>Avg. Reaction Time:</strong></div><div>${avgReactionTime.toFixed(0)} ms</div>
        `;
    };

    // --- Data Handling ---
    const logEvent = (type, details = {}) => {
        state.events.push({ type, trial: state.currentTrial, timestamp: Date.now() - state.gameStartTime, ...details });
    };

    const sendDataToBackend = () => {
        const completionStatus = state.gameCompleted ? 'completed' : 'abandoned';
        const score = state.correctCount;
        const data = {
            game_name: GAME_ID,
            score: score,
            duration_ms: Date.now() - state.gameStartTime,
            completion_status: completionStatus,
            events: state.events,
            game_specific_data: {
                final_difference: state.currentDifference,
                accuracy: (state.correctCount / TOTAL_TRIALS)
            }
        };

        return fetch('{% url "games:save_score" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': gameBody.dataset.csrfToken },
            body: JSON.stringify(data),
        });
    };

    const quitGame = () => {
        if (state.gameStartTime === 0 || finalResultsModal.style.display === 'flex') {
            window.location.href = gameBody.dataset.gameListUrl;
            return;
        }
        state.gameCompleted = false;
        sendDataToBackend().finally(() => window.location.href = gameBody.dataset.gameListUrl);
    };

    // --- Event Listeners ---
    startGameBtn.addEventListener('click', startGame);
    choice1Btn.addEventListener('click', () => handleChoice(parseInt(choice1Btn.textContent)));
    choice2Btn.addEventListener('click', () => handleChoice(parseInt(choice2Btn.textContent)));
    backToGamesBtn.addEventListener('click', (e) => { e.preventDefault(); quitGame(); });
    returnToGamesFinalBtn.addEventListener('click', (e) => { e.preventDefault(); window.location.href = gameBody.dataset.gameListUrl; });
});
</script>
{% endblock %}
