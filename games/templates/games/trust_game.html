{% extends 'base.html' %}

{% block title %}Trust Game - Rasmetric{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
  <div class="max-w-4xl mx-auto px-4 py-8">
    <button
      onclick="window.location.href='{% url 'games:game_list' %}'"
      class="flex items-center text-gray-600 hover:text-gray-900 mb-6"
    >
      <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg>
      Back to Games
    </button>

    <div id="gameContainer" class="text-center">
      <h2 class="text-2xl font-bold text-gray-900 mb-4">Trust Investment Game</h2>
      <div class="bg-white rounded-lg shadow-sm p-8 mb-6">
        <div class="flex justify-between items-center mb-6">
          <div>
            <p class="text-sm text-gray-600">Round: <span id="roundDisplay">1</span>/15</p>
            <p class="text-sm text-gray-600">Money: $<span id="moneyDisplay">100</span></p>
          </div>
        </div>
        <div id="partnerArea"></div>
        <div id="resultArea"></div>
      </div>
    </div>

    <div id="gameOverContainer" class="text-center hidden">
      <h2 class="text-2xl font-bold text-gray-900 mb-4">Investment Complete!</h2>
      <div class="bg-blue-50 rounded-lg p-6 mb-6">
        <p class="text-lg text-gray-700 mb-2">Final Money: <span id="finalMoney" class="font-bold text-blue-600">0</span></p>
        <p class="text-lg text-gray-700 mb-2">Total Profit: <span id="finalProfit" class="font-bold">0</span></p>
        <p class="text-sm text-gray-600">Trust & Cooperation Score: <span id="finalScore">0</span></p>
      </div>
      <button
        onclick="window.location.href='{% url 'games:game_list' %}'"
        class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700"
      >
        Continue
      </button>
    </div>
  </div>
</div>

<script>
const totalRounds = 15;
let round = 1;
let totalMoney = 100;
let gameOver = false;
let startTime = Date.now();
let roundStartTime = Date.now();
let decisions = [];
let reactionTimes = [];
let investmentAmount = 0;
let showResult = false;
let roundResult = null;
// Add partner personalities
const partners = [
  { id: 1, name: 'Alex', trustworthiness: 0.5, personality: 'generous', avatar: '👨', history: [] },
  { id: 2, name: 'Sam', trustworthiness: 0.2, personality: 'stingy', avatar: '👩', history: [] },
  { id: 3, name: 'Jordan', trustworthiness: 0.6, personality: 'unpredictable', avatar: '🧑', history: [] },
  { id: 4, name: 'Casey', trustworthiness: 0.3, personality: 'generous', avatar: '👤', history: [] },
  { id: 5, name: 'Riley', trustworthiness: 0.4, personality: 'stingy', avatar: '👨‍💼', history: [] }
];
let gamePartners = JSON.parse(JSON.stringify(partners));
let currentPartner = null;

function selectRandomPartner() {
  currentPartner = gamePartners[Math.floor(Math.random() * gamePartners.length)];
  investmentAmount = 0;
  showResult = false;
  roundResult = null;
  roundStartTime = Date.now();
  renderPartnerArea();
  renderResultArea();
}
function renderPartnerArea() {
  const area = document.getElementById('partnerArea');
  area.innerHTML = '';
  if (!currentPartner || showResult) return;
  const partnerDiv = document.createElement('div');
  partnerDiv.className = 'bg-gray-50 rounded-lg p-6 mb-6';
  const flex = document.createElement('div');
  flex.className = 'flex items-center justify-center mb-4';
  const avatar = document.createElement('span');
  avatar.className = 'text-4xl mr-3';
  avatar.textContent = currentPartner.avatar;
  flex.appendChild(avatar);
  const info = document.createElement('div');
  const h3 = document.createElement('h3');
  h3.className = 'text-xl font-semibold text-gray-900';
  h3.textContent = currentPartner.name;
  info.appendChild(h3);
  const p = document.createElement('p');
  p.className = 'text-sm text-gray-600';
  p.textContent = 'Investment Partner';
  info.appendChild(p);
  flex.appendChild(info);
  partnerDiv.appendChild(flex);
  if (currentPartner.history.length > 0) {
    const past = document.createElement('div');
    past.className = 'mb-4';
    const label = document.createElement('p');
    label.className = 'text-sm text-gray-600 mb-2';
    label.textContent = 'Past Returns:';
    past.appendChild(label);
    const returnsDiv = document.createElement('div');
    returnsDiv.className = 'flex justify-center space-x-2';
    currentPartner.history.slice(-5).forEach(return_ => {
      const span = document.createElement('span');
      span.className = 'px-2 py-1 bg-blue-100 text-blue-800 rounded text-sm';
      span.textContent = '$' + return_;
      returnsDiv.appendChild(span);
    });
    past.appendChild(returnsDiv);
    partnerDiv.appendChild(past);
  }
  area.appendChild(partnerDiv);
  // Investment UI
  const investDiv = document.createElement('div');
  investDiv.className = 'mb-6';
  const investPrompt = document.createElement('p');
  investPrompt.className = 'text-lg text-gray-700 mb-4';
  investPrompt.textContent = `How much would you like to invest with ${currentPartner.name}?`;
  investDiv.appendChild(investPrompt);
  const investDesc = document.createElement('p');
  investDesc.className = 'text-sm text-gray-600 mb-4';
  investDesc.textContent = `Your investment will be tripled and ${currentPartner.name} will decide how much to return.`;
  investDiv.appendChild(investDesc);
  const sliderDiv = document.createElement('div');
  sliderDiv.className = 'max-w-xs mx-auto mb-4';
  // Tooltip for risk
  const sliderLabelRow = document.createElement('div');
  sliderLabelRow.className = 'flex items-center mb-1';
  const sliderLabel = document.createElement('label');
  sliderLabel.className = 'text-sm font-medium text-gray-700';
  sliderLabel.textContent = 'Allocate:';
  sliderLabelRow.appendChild(sliderLabel);
  const tooltip = document.createElement('span');
  tooltip.className = 'ml-2 text-xs text-gray-400 cursor-pointer';
  tooltip.title = 'Higher investments can lead to higher returns, but are riskier if the partner is untrustworthy.';
  tooltip.innerHTML = '<svg class="inline h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="2"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 16v-4m0-4h.01"/></svg>';
  sliderLabelRow.appendChild(tooltip);
  sliderDiv.appendChild(sliderLabelRow);
  const input = document.createElement('input');
  input.type = 'range';
  input.min = 0;
  input.max = Math.min(totalMoney, 20);
  input.value = investmentAmount;
  input.className = 'w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer';
  input.oninput = e => {
    investmentAmount = parseInt(e.target.value);
    setSliderColor(input, investmentAmount, input.max);
    renderPartnerArea();
  };
  sliderDiv.appendChild(input);
  setSliderColor(input, investmentAmount, input.max);
  const sliderLabels = document.createElement('div');
  sliderLabels.className = 'flex justify-between text-sm text-gray-600 mt-1';
  sliderLabels.innerHTML = `<span>$0</span><span class="font-bold text-blue-600">$${investmentAmount}</span><span>$${input.max}</span>`;
  sliderDiv.appendChild(sliderLabels);
  investDiv.appendChild(sliderDiv);
  const investBtn = document.createElement('button');
  investBtn.className = 'bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed';
  investBtn.textContent = `Invest $${investmentAmount}`;
  investBtn.disabled = investmentAmount <= 0;
  investBtn.onclick = handleInvestment;
  investDiv.appendChild(investBtn);
  area.appendChild(investDiv);
}
function setSliderColor(slider, value, max) {
  const percent = (value / max) * 100;
  slider.style.background = `linear-gradient(to right, #16a34a 0%, #16a34a ${percent}%, #e5e7eb ${percent}%, #e5e7eb 100%)`;
}
function renderResultArea() {
  const area = document.getElementById('resultArea');
  area.innerHTML = '';
  if (showResult && roundResult) {
    const resultDiv = document.createElement('div');
    resultDiv.className = 'mb-8';
    const box = document.createElement('div');
    box.className = 'bg-blue-50 rounded-lg p-6';
    const h3 = document.createElement('h3');
    h3.className = 'text-lg font-semibold text-gray-900 mb-4';
    h3.textContent = 'Round Result';
    box.appendChild(h3);
    // Partner reaction emoji
    const reaction = document.createElement('div');
    reaction.className = 'text-3xl mb-2';
    if (roundResult.returned >= roundResult.invested * 2) {
      reaction.textContent = '😃';
    } else if (roundResult.returned >= roundResult.invested) {
      reaction.textContent = '🙂';
    } else if (roundResult.returned > 0) {
      reaction.textContent = '😐';
    } else {
      reaction.textContent = '😞';
    }
    box.appendChild(reaction);
    // Feedback message
    const feedback = document.createElement('div');
    feedback.className = 'mb-2 text-sm';
    if (roundResult.returned >= roundResult.invested * 2) {
      feedback.textContent = `${currentPartner.name} was very generous!`;
    } else if (roundResult.returned >= roundResult.invested) {
      feedback.textContent = `${currentPartner.name} returned a fair amount.`;
    } else if (roundResult.returned > 0) {
      feedback.textContent = `${currentPartner.name} kept most of the money.`;
    } else {
      feedback.textContent = `${currentPartner.name} kept everything!`;
    }
    box.appendChild(feedback);
    const s1 = document.createElement('p');
    s1.className = 'text-gray-700';
    s1.innerHTML = `You invested: <span class="font-bold">$${roundResult.invested}</span>`;
    box.appendChild(s1);
    const s2 = document.createElement('p');
    s2.className = 'text-gray-700';
    s2.innerHTML = `Tripled amount: <span class="font-bold">$${roundResult.invested * 3}</span>`;
    box.appendChild(s2);
    const s3 = document.createElement('p');
    s3.className = 'text-gray-700';
    s3.innerHTML = `${currentPartner.name} returned: <span class="font-bold">$${roundResult.returned}</span>`;
    box.appendChild(s3);
    const s4 = document.createElement('p');
    s4.className = `text-lg font-bold ${roundResult.profit >= 0 ? 'text-green-600' : 'text-red-600'}`;
    s4.textContent = `Your profit: $${roundResult.profit}`;
    box.appendChild(s4);
    // Animate profit/loss
    setTimeout(() => {
      s4.classList.add('animate-pulse');
      setTimeout(() => s4.classList.remove('animate-pulse'), 600);
    }, 100);
    resultDiv.appendChild(box);
    area.appendChild(resultDiv);
  }
}
function handleInvestment() {
  if (!currentPartner || investmentAmount <= 0) return;
  const reactionTime = Date.now() - roundStartTime;
  reactionTimes.push(reactionTime);
  const multiplier = 3;
  const tripled = investmentAmount * multiplier;
  // Partner memory: adjust trustworthiness based on past investments
  let effectiveTrust = currentPartner.trustworthiness;
  const pastInvestments = currentPartner.history.length;
  if (pastInvestments > 0) {
    const avgPastInvestment = currentPartner.history.reduce((a, b) => a + b, 0) / pastInvestments;
    if (investmentAmount > avgPastInvestment) {
      effectiveTrust += 0.05; // reward higher trust
    } else if (investmentAmount < avgPastInvestment) {
      effectiveTrust -= 0.05; // penalize lower trust
    }
  }
  // Partner personality
  let returnRate = effectiveTrust;
  if (currentPartner.personality === 'unpredictable') {
    returnRate = Math.random();
  } else if (currentPartner.personality === 'generous') {
    returnRate += 0.1;
  } else if (currentPartner.personality === 'stingy') {
    returnRate -= 0.1;
  }
  // Add more risk/volatility
  returnRate += (Math.random() * 0.4 - 0.2);
  returnRate = Math.max(0, Math.min(1, returnRate));
  const returned = Math.round(tripled * returnRate);
  const profit = returned - investmentAmount;
  // Update partner history
  gamePartners = gamePartners.map(p =>
    p.id === currentPartner.id
      ? { ...p, history: [...p.history, returned] }
      : p
  );
  currentPartner.history.push(returned);
  roundResult = { invested: investmentAmount, returned, profit };
  totalMoney = totalMoney - investmentAmount + returned;
  document.getElementById('moneyDisplay').textContent = totalMoney;
  decisions.push({
    round: round,
    partnerId: currentPartner.id,
    partnerName: currentPartner.name,
    invested: investmentAmount,
    returned,
    profit,
    trustworthiness: currentPartner.trustworthiness,
    personality: currentPartner.personality,
    reactionTime
  });
  showResult = true;
  renderPartnerArea();
  renderResultArea();
  setTimeout(() => {
    if (round < totalRounds) {
      round++;
      document.getElementById('roundDisplay').textContent = round;
      selectRandomPartner();
      renderResultArea();
    } else {
      endGame();
    }
  }, 3000);
}
function endGame() {
  gameOver = true;
  document.getElementById('gameContainer').classList.add('hidden');
  document.getElementById('gameOverContainer').classList.remove('hidden');
  document.getElementById('finalMoney').textContent = totalMoney;
  const totalProfit = totalMoney - 100;
  document.getElementById('finalProfit').textContent = (totalProfit >= 0 ? '+' : '') + '$' + totalProfit;
  const score = Math.max(0, Math.min(100, 50 + totalProfit));
  document.getElementById('finalScore').textContent = score;
  renderAnalyticsSummary();
  saveGameResult(score);
}
function renderAnalyticsSummary() {
  const container = document.getElementById('gameOverContainer');
  // Remove old summary if present
  const oldSummary = document.getElementById('analyticsSummary');
  if (oldSummary) oldSummary.remove();
  const summary = document.createElement('div');
  summary.id = 'analyticsSummary';
  summary.className = 'bg-white rounded-lg shadow-sm p-6 mt-6 text-left';
  // Average investment
  const avgInvestment = decisions.reduce((sum, d) => sum + d.invested, 0) / decisions.length;
  // Most/least trusted partner
  const partnerStats = {};
  decisions.forEach(d => {
    if (!partnerStats[d.partnerName]) partnerStats[d.partnerName] = { invested: 0, count: 0 };
    partnerStats[d.partnerName].invested += d.invested;
    partnerStats[d.partnerName].count += 1;
  });
  let mostTrusted = '', leastTrusted = '', maxAvg = -Infinity, minAvg = Infinity;
  Object.entries(partnerStats).forEach(([name, stat]) => {
    const avg = stat.invested / stat.count;
    if (avg > maxAvg) { maxAvg = avg; mostTrusted = name; }
    if (avg < minAvg) { minAvg = avg; leastTrusted = name; }
  });
  // Best/worst round
  let bestRound = null, worstRound = null;
  decisions.forEach(d => {
    if (!bestRound || d.profit > bestRound.profit) bestRound = d;
    if (!worstRound || d.profit < worstRound.profit) worstRound = d;
  });
  summary.innerHTML = `
    <h3 class="text-lg font-semibold text-gray-900 mb-2">Game Analytics</h3>
    <ul class="mb-2 text-sm text-gray-700">
      <li><strong>Average Investment:</strong> $${avgInvestment.toFixed(2)}</li>
      <li><strong>Most Trusted Partner:</strong> ${mostTrusted} ($${maxAvg.toFixed(2)} avg)</li>
      <li><strong>Least Trusted Partner:</strong> ${leastTrusted} ($${minAvg.toFixed(2)} avg)</li>
      <li><strong>Best Round:</strong> Round ${bestRound ? bestRound.round : '-'} ($${bestRound ? bestRound.profit : '-'} profit)</li>
      <li><strong>Worst Round:</strong> Round ${worstRound ? worstRound.round : '-'} ($${worstRound ? worstRound.profit : '-'} profit)</li>
    </ul>
    <div class="mt-4">
      <h4 class="font-semibold mb-1">Investment & Return Over Time</h4>
      <div id="investmentGraph" class="w-full h-24 bg-gray-100 rounded"></div>
      <p class="text-xs text-gray-500 mt-1">(Graph placeholder: implement with Chart.js or similar for full analytics)</p>
    </div>
  `;
  container.appendChild(summary);
  // Optionally, you can add a simple bar graph or sparkline here using a library or custom SVG.
}
function saveGameResult(score) {
  const totalTime = Date.now() - startTime;
  const totalProfit = totalMoney - 100;
  const averageInvestment = decisions.reduce((sum, d) => sum + d.invested, 0) / decisions.length;
  const gameData = {
    game_type: 'trust_game',
    score: score,
    duration: totalTime,
    decisions: decisions,
    reaction_times: reactionTimes,
    raw_data: {
      finalMoney: totalMoney,
      totalProfit: totalProfit,
      averageInvestment: averageInvestment,
      averageReactionTime: reactionTimes.length ? reactionTimes.reduce((a, b) => a + b, 0) / reactionTimes.length : 0,
      trustBehavior: {
        highTrustInvestments: decisions.filter(d => d.trustworthiness > 0.7 && d.invested > 20).length,
        lowTrustInvestments: decisions.filter(d => d.trustworthiness < 0.4 && d.invested > 20).length
      }
    }
  };
  fetch('{% url "games:save_game_result" %}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    },
    body: JSON.stringify(gameData)
  })
  .then(response => response.json())
  .then(data => {
    console.log('Game result saved:', data);
  })
  .catch(error => {
    console.error('Error saving game result:', error);
  });
}
document.addEventListener('DOMContentLoaded', function() {
  selectRandomPartner();
  document.getElementById('roundDisplay').textContent = round;
  document.getElementById('moneyDisplay').textContent = totalMoney;
});
</script>

{% csrf_token %}
{% endblock %} 