{% extends 'base.html' %}

{% block title %}Sorting Task Game - Rasmetric{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
  <div class="max-w-4xl mx-auto px-4 py-8">
    <button
      onclick="window.location.href='{% url 'game_list' %}'"
      class="flex items-center text-gray-600 hover:text-gray-900 mb-6"
    >
      <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg>
      Back to Games
    </button>

    <div id="gameContainer" class="text-center">
      <h2 class="text-2xl font-bold text-gray-900 mb-4">Sorting Task</h2>
      <div class="bg-white rounded-lg shadow-sm p-8 mb-6">
        <div class="flex justify-between items-center mb-6">
          <div>
            <p class="text-sm text-gray-600">Score: <span id="scoreDisplay">0</span></p>
            <p class="text-sm text-gray-600">Missed: <span id="missedDisplay">0</span>/10</p>
          </div>
          <div class="text-right">
            <p class="text-sm text-gray-600">Speed: <span id="speedDisplay">1.0</span>x</p>
          </div>
        </div>

        <div class="relative bg-gray-100 rounded-lg overflow-hidden" style="height: 400px;" id="gameArea">
          <!-- Falling objects will be rendered here -->
        </div>

        <div class="flex justify-center space-x-4 mt-6">
          <button
            onclick="handleBinClick('fruit')"
            class="bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700 flex items-center"
          >
            üçé Fruit
          </button>
          <button
            onclick="handleBinClick('animal')"
            class="bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 flex items-center"
          >
            üê∂ Animal
          </button>
          <button
            onclick="handleBinClick('vehicle')"
            class="bg-purple-600 text-white px-6 py-3 rounded-md hover:bg-purple-700 flex items-center"
          >
            üöó Vehicle
          </button>
        </div>
      </div>
    </div>

    <div id="gameOverContainer" class="text-center hidden">
      <h2 class="text-2xl font-bold text-gray-900 mb-4">Game Complete!</h2>
      <div class="bg-blue-50 rounded-lg p-6 mb-6">
        <p class="text-lg text-gray-700 mb-2">Final Score: <span id="finalScore" class="font-bold text-blue-600">0</span></p>
        <p class="text-lg text-gray-700 mb-2">Objects Missed: <span id="finalMissed" class="font-bold text-red-600">0</span></p>
        <p class="text-sm text-gray-600">Accuracy: <span id="finalAccuracy">0</span>%</p>
      </div>
      <button
        onclick="window.location.href='{% url 'game_list' %}'"
        class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700"
      >
        Continue
      </button>
    </div>
  </div>
</div>

<script>
const objectTypes = {
  fruit: ['üçé', 'üçå', 'üçá', 'üçä', 'üçì'],
  animal: ['üê∂', 'üê±', 'üê∏', 'üê∞', 'üê®'],
  vehicle: ['üöó', 'üö≤', '‚úàÔ∏è', 'üö¢', 'üöÇ']
};
let objects = [];
let score = 0;
let missed = 0;
let gameOver = false;
let speed = 1.0;
let startTime = Date.now();
let decisions = [];
let reactionTimes = [];
let clickStartTime = 0;
let gameLoopInterval = null;

function spawnObject() {
  const types = Object.keys(objectTypes);
  const type = types[Math.floor(Math.random() * types.length)];
  const icons = objectTypes[type];
  const icon = icons[Math.floor(Math.random() * icons.length)];
  const newObj = {
    id: Date.now() + Math.random(),
    type: type,
    icon: icon,
    x: Math.random() * 400 + 50,
    y: -50,
    speed: Math.random() * 2 + 3
  };
  objects.push(newObj);
}

function renderObjects() {
  const gameArea = document.getElementById('gameArea');
  gameArea.innerHTML = '';
  objects.forEach(obj => {
    const el = document.createElement('div');
    el.className = 'absolute text-2xl cursor-pointer transition-all duration-100 hover:scale-110';
    el.style.left = obj.x + 'px';
    el.style.top = obj.y + 'px';
    el.textContent = obj.icon;
    el.onclick = () => handleObjectClick(obj.id);
    gameArea.appendChild(el);
  });
}

function updateDisplay() {
  document.getElementById('scoreDisplay').textContent = score;
  document.getElementById('missedDisplay').textContent = missed;
  document.getElementById('speedDisplay').textContent = speed.toFixed(1);
}

function handleObjectClick(objectId) {
  clickStartTime = Date.now();
}

function handleBinClick(binType) {
  if (objects.length === 0) return;
  const objectId = objects[0].id;
  const reactionTime = Date.now() - clickStartTime;
  reactionTimes.push(reactionTime);
  const object = objects.find(obj => obj.id === objectId);
  if (object && object.type === binType) {
    score += 10;
    decisions.push({
      objectId: objectId,
      objectType: object.type,
      binType: binType,
      correct: true,
      reactionTime: reactionTime
    });
  } else {
    score = Math.max(0, score - 5);
    decisions.push({
      objectId: objectId,
      objectType: object ? object.type : null,
      binType: binType,
      correct: false,
      reactionTime: reactionTime
    });
  }
  objects = objects.filter(obj => obj.id !== objectId);
  updateDisplay();
  renderObjects();
}

function gameLoop() {
  if (Math.random() < 0.3) {
    spawnObject();
  }
  objects.forEach(obj => {
    obj.y += obj.speed * speed;
  });
  // Remove objects that fell off screen
  const remaining = objects.filter(obj => obj.y < 600);
  const fell = objects.filter(obj => obj.y >= 600);
  if (fell.length > 0) {
    missed += fell.length;
    updateDisplay();
  }
  objects = remaining;
  speed += 0.001;
  updateDisplay();
  renderObjects();
  if (missed >= 10) {
    endGame();
  }
}

function endGame() {
  gameOver = true;
  clearInterval(gameLoopInterval);
  const totalTime = Date.now() - startTime;
  const accuracy = decisions.length > 0 ? decisions.filter(d => d.correct).length / decisions.length : 0;
  document.getElementById('gameContainer').classList.add('hidden');
  document.getElementById('gameOverContainer').classList.remove('hidden');
  document.getElementById('finalScore').textContent = Math.min(score, 100);
  document.getElementById('finalMissed').textContent = missed;
  document.getElementById('finalAccuracy').textContent = Math.round(accuracy * 100);
  saveGameResult(totalTime, accuracy);
}

function saveGameResult(totalTime, accuracy) {
  const gameData = {
    game_type: 'sorting_task',
    score: Math.min(score, 100),
    duration: totalTime,
    decisions: decisions,
    reaction_times: reactionTimes,
    raw_data: {
      finalScore: score,
      objectsMissed: missed,
      accuracy: accuracy,
      finalSpeed: speed,
      averageReactionTime: reactionTimes.reduce((a, b) => a + b, 0) / (reactionTimes.length || 1)
    }
  };
  fetch('{% url "games:save_game_result" %}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    },
    body: JSON.stringify(gameData)
  })
  .then(response => response.json())
  .then(data => {
    console.log('Game result saved:', data);
  })
  .catch(error => {
    console.error('Error saving game result:', error);
  });
}

document.addEventListener('DOMContentLoaded', function() {
  updateDisplay();
  renderObjects();
  gameLoopInterval = setInterval(() => {
    if (!gameOver) gameLoop();
  }, 50);
});
</script>

{% csrf_token %}
{% endblock %} 