{% extends 'base.html' %}

{% block title %}Digit Span Game - Rasmetric{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
  <div class="max-w-4xl mx-auto px-4 py-8">
    <button
      onclick="window.location.href='{% url 'games:game_list' %}'"
      class="flex items-center text-gray-600 hover:text-gray-900 mb-6"
    >
      <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg>
      Back to Games
    </button>

    <div id="gameContainer" class="text-center"></div>
    <div id="gameOverContainer" class="text-center hidden">
      <h2 class="text-2xl font-bold text-gray-900 mb-4">Memory Test Complete!</h2>
      <div class="bg-blue-50 rounded-lg p-6 mb-6">
        <p class="text-lg text-gray-700 mb-2">Final Score: <span id="finalScore" class="font-bold text-blue-600">0</span></p>
        <p class="text-lg text-gray-700 mb-2">Max Span: <span id="finalMaxSpan" class="font-bold text-green-600">0</span> digits</p>
        <p class="text-lg text-gray-700 mb-2">Accuracy: <span id="finalAccuracy" class="font-bold text-blue-600">0%</span></p>
        <p class="text-sm text-gray-600">Working Memory Span: <span id="finalSpan">0</span>/9</p>
      </div>
      <button
        onclick="window.location.href='{% url 'games:game_list' %}'"
        class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700"
      >
        Continue
      </button>
    </div>
  </div>
</div>

<script>
const maxRounds = 20;
let gamePhase = 'instructions';
let currentSequence = [];
let userInput = [];
let sequenceLength = 3;
let currentDigitIndex = 0;
let score = 0;
let consecutiveCorrect = 0;
let consecutiveWrong = 0;
let round = 1;
let startTime = Date.now();
let decisions = [];
let reactionTimes = [];
let inputStartTime = 0;
let feedback = '';

function renderGame() {
  const container = document.getElementById('gameContainer');
  container.innerHTML = '';
  if (gamePhase === 'instructions') {
    const title = document.createElement('h2');
    title.className = 'text-2xl font-bold text-gray-900 mb-4';
    title.textContent = 'Digit Span Memory';
    container.appendChild(title);
    const box = document.createElement('div');
    box.className = 'bg-white rounded-lg shadow-sm p-8 mb-6';
    box.innerHTML = `
      <div class="mb-6">
        <p class="text-lg text-gray-700 mb-4">You will see a sequence of numbers.</p>
        <p class="text-lg text-gray-700 mb-4">Watch carefully and remember the order.</p>
        <p class="text-lg text-gray-700 mb-4">Then click the numbers in the same sequence.</p>
      </div>
      <button id="startBtn" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700">Start Game</button>
    `;
    container.appendChild(box);
    document.getElementById('startBtn').onclick = startRound;
    return;
  }
  if (gamePhase === 'finished') return;
  const title = document.createElement('h2');
  title.className = 'text-2xl font-bold text-gray-900 mb-4';
  title.textContent = 'Digit Span Memory';
  container.appendChild(title);
  const box = document.createElement('div');
  box.className = 'bg-white rounded-lg shadow-sm p-8 mb-6';
  box.innerHTML = `
    <div class="flex justify-between items-center mb-6">
      <div>
        <p class="text-sm text-gray-600">Round: ${round}/${maxRounds}</p>
        <p class="text-sm text-gray-600">Score: ${score}</p>
      </div>
      <div class="text-right">
        <p class="text-sm text-gray-600">Sequence Length: ${sequenceLength}</p>
      </div>
    </div>
  `;
  if (gamePhase === 'showing') {
    const showDiv = document.createElement('div');
    showDiv.className = 'mb-8';
    showDiv.innerHTML = `<p class="text-lg text-gray-700 mb-6">Watch the sequence:</p>`;
    const digitDiv = document.createElement('div');
    digitDiv.className = 'h-32 flex items-center justify-center';
    if (currentDigitIndex < currentSequence.length) {
      digitDiv.innerHTML = `<div class="text-8xl font-bold text-blue-600 animate-pulse">${currentSequence[currentDigitIndex]}</div>`;
    } else {
      digitDiv.innerHTML = '<div class="text-2xl text-gray-500">Sequence complete</div>';
    }
    showDiv.appendChild(digitDiv);
    const dots = document.createElement('div');
    dots.className = 'flex justify-center space-x-2 mt-4';
    for (let i = 0; i < currentSequence.length; i++) {
      const dot = document.createElement('div');
      dot.className = `w-3 h-3 rounded-full ${i <= currentDigitIndex ? 'bg-blue-600' : 'bg-gray-300'}`;
      showDiv.appendChild(dot);
    }
    showDiv.appendChild(dots);
    box.appendChild(showDiv);
  }
  if (gamePhase === 'input') {
    const inputDiv = document.createElement('div');
    inputDiv.className = 'mb-8';
    inputDiv.innerHTML = `<p class="text-lg text-gray-700 mb-6">Click the numbers in the same order:</p>`;
    const inputRow = document.createElement('div');
    inputRow.className = 'flex justify-center space-x-2 mb-4';
    for (let i = 0; i < userInput.length; i++) {
      const d = document.createElement('div');
      d.className = 'w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center text-xl font-bold text-blue-800';
      d.textContent = userInput[i];
      inputRow.appendChild(d);
    }
    for (let i = userInput.length; i < currentSequence.length; i++) {
      const d = document.createElement('div');
      d.className = 'w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center text-xl text-gray-400';
      d.textContent = '?';
      inputRow.appendChild(d);
    }
    inputDiv.appendChild(inputRow);
    const grid = document.createElement('div');
    grid.className = 'grid grid-cols-3 gap-4 max-w-xs mx-auto';
    for (let digit = 1; digit <= 9; digit++) {
      const btn = document.createElement('button');
      btn.className = 'bg-gray-100 hover:bg-blue-200 text-xl font-bold rounded-lg p-4';
      btn.textContent = digit;
      btn.onclick = () => handleDigitClick(digit);
      grid.appendChild(btn);
    }
    inputDiv.appendChild(grid);
    box.appendChild(inputDiv);
  }
  if (gamePhase === 'feedback') {
    const feedbackDiv = document.createElement('div');
    feedbackDiv.className = `mb-6 p-3 rounded-lg text-lg font-semibold ${feedback.includes('Correct') ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
    feedbackDiv.textContent = feedback;
    box.appendChild(feedbackDiv);
  }
  container.appendChild(box);
}
function generateSequence() {
  const sequence = [];
  for (let i = 0; i < sequenceLength; i++) {
    sequence.push(Math.floor(Math.random() * 9) + 1);
  }
  return sequence;
}
function startRound() {
  currentSequence = generateSequence();
  userInput = [];
  currentDigitIndex = 0;
  gamePhase = 'showing';
  renderGame();
  showNextDigit();
}
function showNextDigit() {
  if (currentDigitIndex < currentSequence.length) {
    setTimeout(() => {
      currentDigitIndex++;
      renderGame();
      showNextDigit();
    }, 1000);
  } else {
    setTimeout(() => {
      gamePhase = 'input';
      inputStartTime = Date.now();
      renderGame();
    }, 500);
  }
}
function handleDigitClick(digit) {
  userInput.push(digit);
  renderGame();
  if (userInput.length === currentSequence.length) {
    const isCorrect = userInput.every((d, i) => d === currentSequence[i]);
    const reactionTime = Date.now() - inputStartTime;
    reactionTimes.push(reactionTime);
    decisions.push({
      round,
      sequenceLength,
      sequence: currentSequence.slice(),
      userInput: userInput.slice(),
      correct: isCorrect,
      reactionTime
    });
    if (isCorrect) {
      score += sequenceLength * 10;
      consecutiveCorrect++;
      consecutiveWrong = 0;
      feedback = 'Correct! âœ“';
      if (consecutiveCorrect >= 2 && sequenceLength < 8) {
        sequenceLength++;
        consecutiveCorrect = 0;
      }
    } else {
      consecutiveWrong++;
      consecutiveCorrect = 0;
      feedback = 'Incorrect. Try again!';
      if (consecutiveWrong >= 2 && sequenceLength > 3) {
        sequenceLength--;
        consecutiveWrong = 0;
      }
    }
    gamePhase = 'feedback';
    renderGame();
    setTimeout(() => {
      if (round < maxRounds) {
        round++;
        startRound();
      } else {
        endGame();
      }
    }, 2000);
  }
}
function endGame() {
  gamePhase = 'finished';
  document.getElementById('gameContainer').classList.add('hidden');
  document.getElementById('gameOverContainer').classList.remove('hidden');
  document.getElementById('finalScore').textContent = score;
  const maxSpan = Math.max(...decisions.map(d => d.sequenceLength));
  document.getElementById('finalMaxSpan').textContent = maxSpan;
  const accuracy = decisions.filter(d => d.correct).length / decisions.length;
  document.getElementById('finalAccuracy').textContent = Math.round(accuracy * 100) + '%';
  document.getElementById('finalSpan').textContent = maxSpan;
  saveGameResult(maxSpan, accuracy);
}
function saveGameResult(maxSpan, accuracy) {
  const totalTime = Date.now() - startTime;
  const gameData = {
    game_type: 'digit_span',
    score: Math.min(score, 100),
    duration: totalTime,
    decisions: decisions,
    reaction_times: reactionTimes,
    raw_data: {
      finalScore: score,
      accuracy: accuracy,
      maxSpan: maxSpan,
      averageReactionTime: reactionTimes.length ? reactionTimes.reduce((a, b) => a + b, 0) / reactionTimes.length : 0,
      finalSequenceLength: sequenceLength
    }
  };
  fetch('{% url "games:save_game_result" %}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    },
    body: JSON.stringify(gameData)
  })
  .then(response => response.json())
  .then(data => {
    console.log('Game result saved:', data);
  })
  .catch(error => {
    console.error('Error saving game result:', error);
  });
}
document.addEventListener('DOMContentLoaded', function() {
  renderGame();
});
</script>

{% csrf_token %}
{% endblock %} 