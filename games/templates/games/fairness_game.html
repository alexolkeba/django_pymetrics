{% extends 'base.html' %}

{% block title %}Fairness Game - Rasmetric{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
  <div class="max-w-4xl mx-auto px-4 py-8">
    <button
      onclick="window.location.href='{% url 'game_list' %}'"
      class="flex items-center text-gray-600 hover:text-gray-900 mb-6"
    >
      <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg>
      Back to Games
    </button>

    <div id="gameContainer" class="text-center">
      <h2 class="text-2xl font-bold text-gray-900 mb-4">Fairness Allocation</h2>
      <div class="bg-white rounded-lg shadow-sm p-8 mb-6">
        <div class="flex justify-between items-center mb-6">
          <div>
            <p class="text-sm text-gray-600">Round: <span id="roundDisplay">1</span>/10</p>
          </div>
          <div class="text-right">
            <p class="text-sm text-gray-600">Resources: <span id="allocatedDisplay">0</span>/<span id="totalResourcesDisplay">0</span></p>
          </div>
        </div>
        <div id="scenarioContainer" class="mb-8"></div>
        <div id="groupsContainer" class="space-y-6"></div>
        <div class="mt-6">
          <button
            id="submitButton"
            onclick="submitAllocation()"
            class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700"
          >
            Submit Allocation
          </button>
        </div>
      </div>
    </div>

    <div id="resultContainer" class="text-center hidden">
      <h2 class="text-2xl font-bold text-gray-900 mb-4">Fairness Assessment Complete!</h2>
      <div class="bg-blue-50 rounded-lg p-6 mb-6">
        <p class="text-lg text-gray-700 mb-2">Average Equity Score: <span id="finalEquity" class="font-bold text-blue-600">0</span></p>
        <p class="text-lg text-gray-700 mb-2">Scenarios Completed: <span id="finalRounds" class="font-bold text-green-600">10</span></p>
        <p class="text-sm text-gray-600">Fairness & Ethics Rating: <span id="finalEquityPercent">0</span>%</p>
      </div>
      <button
        onclick="window.location.href='{% url 'game_list' %}'"
        class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700"
      >
        Continue
      </button>
    </div>
  </div>
</div>

<script>
const scenarios = [
  {
    id: 1,
    title: 'Food Distribution',
    description: 'Distribute food supplies among different communities',
    totalResources: 100,
    groups: [
      { name: 'Urban Community', size: 50, need: 0.8, description: 'Limited access to fresh food' },
      { name: 'Rural Village', size: 30, need: 0.9, description: 'Drought affected area' },
      { name: 'Refugee Camp', size: 20, need: 1.0, description: 'Emergency situation' }
    ]
  },
  {
    id: 2,
    title: 'Medical Supplies',
    description: 'Allocate medical equipment to hospitals',
    totalResources: 80,
    groups: [
      { name: 'City Hospital', size: 100, need: 0.7, description: 'Well-equipped but high demand' },
      { name: 'Rural Clinic', size: 25, need: 0.9, description: 'Limited resources' },
      { name: 'Emergency Center', size: 40, need: 0.8, description: 'Critical care facility' }
    ]
  },
  {
    id: 3,
    title: 'Educational Resources',
    description: 'Distribute learning materials to schools',
    totalResources: 120,
    groups: [
      { name: 'Public School', size: 200, need: 0.6, description: 'Large student body' },
      { name: 'Special Needs School', size: 30, need: 1.0, description: 'Requires specialized materials' },
      { name: 'Remote School', size: 50, need: 0.8, description: 'Limited access to resources' }
    ]
  }
];
let round = 1;
const totalRounds = 10;
let currentScenario = null;
let allocations = {};
let gameOver = false;
let startTime = Date.now();
let roundStartTime = Date.now();
let decisions = [];
let reactionTimes = [];

function generateScenario() {
  currentScenario = scenarios[Math.floor(Math.random() * scenarios.length)];
  allocations = {};
  currentScenario.groups.forEach(group => {
    allocations[group.name] = 0;
  });
  document.getElementById('totalResourcesDisplay').textContent = currentScenario.totalResources;
  document.getElementById('allocatedDisplay').textContent = 0;
  document.getElementById('roundDisplay').textContent = round;
  renderScenario();
  renderGroups();
  roundStartTime = Date.now();
}

function renderScenario() {
  const scenarioContainer = document.getElementById('scenarioContainer');
  scenarioContainer.innerHTML = `
    <div class="bg-gray-50 rounded-lg p-6 mb-6">
      <h3 class="text-xl font-semibold text-gray-900 mb-2">${currentScenario.title}</h3>
      <p class="text-gray-700 mb-4">${currentScenario.description}</p>
      <p class="text-sm text-gray-600">Total resources available: ${currentScenario.totalResources} units</p>
    </div>
  `;
}

function renderGroups() {
  const groupsContainer = document.getElementById('groupsContainer');
  groupsContainer.innerHTML = '';
  currentScenario.groups.forEach(group => {
    const groupDiv = document.createElement('div');
    groupDiv.className = 'bg-blue-50 rounded-lg p-4 mb-4';
    groupDiv.innerHTML = `
      <div class="flex justify-between items-start mb-3">
        <div class="text-left">
          <h4 class="font-semibold text-gray-900">${group.name}</h4>
          <p class="text-sm text-gray-600">${group.description}</p>
          <p class="text-xs text-gray-500">Size: ${group.size} people | Need level: ${Math.round(group.need * 100)}%</p>
        </div>
      </div>
      <div class="flex items-center space-x-4">
        <label class="text-sm font-medium text-gray-700">Allocate:</label>
        <input type="range" min="0" max="${currentScenario.totalResources}" value="${allocations[group.name]}" oninput="handleAllocationChange('${group.name}', this.value)" class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" id="slider_${group.name}" />
        <span class="text-sm font-bold text-blue-600 w-12 transition-colors duration-200" id="allocationDisplay_${group.name}">${allocations[group.name]}</span>
      </div>
    `;
    groupsContainer.appendChild(groupDiv);
    // Set initial slider color
    setSliderColor(`slider_${group.name}`, allocations[group.name], currentScenario.totalResources);
  });
}

function setSliderColor(sliderId, value, max) {
  const slider = document.getElementById(sliderId);
  if (!slider) return;
  const percent = (value / max) * 100;
  slider.style.background = `linear-gradient(to right, #16a34a 0%, #16a34a ${percent}%, #e5e7eb ${percent}%, #e5e7eb 100%)`;
}

function handleAllocationChange(groupName, value) {
  allocations[groupName] = parseInt(value);
  const display = document.getElementById(`allocationDisplay_${groupName}`);
  display.textContent = value;
  display.style.color = '#16a34a'; // green-600
  document.getElementById('allocatedDisplay').textContent = getTotalAllocated();
  setSliderColor(`slider_${groupName}`, value, currentScenario.totalResources);
  setTimeout(() => {
    display.style.color = '';
  }, 400);
}

function getTotalAllocated() {
  return Object.values(allocations).reduce((sum, val) => sum + val, 0);
}

function submitAllocation() {
  if (!currentScenario) return;
  const reactionTime = Date.now() - roundStartTime;
  reactionTimes.push(reactionTime);
  const totalAllocated = getTotalAllocated();
  const fairnessScores = currentScenario.groups.map(group => {
    const allocated = allocations[group.name];
    const needed = group.size * group.need;
    const fairnessRatio = allocated / needed;
    return { group: group.name, fairnessRatio, allocated, needed };
  });
  const fairnessRatios = fairnessScores.map(s => s.fairnessRatio);
  const averageFairness = fairnessRatios.reduce((a, b) => a + b, 0) / fairnessRatios.length;
  const fairnessVariance = fairnessRatios.reduce((sum, ratio) => sum + Math.pow(ratio - averageFairness, 2), 0) / fairnessRatios.length;
  const equityScore = Math.max(0, 100 - (fairnessVariance * 100));
  decisions.push({
    round,
    scenarioId: currentScenario.id,
    scenarioTitle: currentScenario.title,
    totalResources: currentScenario.totalResources,
    allocations: { ...allocations },
    totalAllocated,
    fairnessScores,
    averageFairness,
    equityScore,
    reactionTime
  });
  if (round < totalRounds) {
    round++;
    generateScenario();
  } else {
    endGame();
  }
}

function endGame() {
  gameOver = true;
  const totalTime = Date.now() - startTime;
  const averageEquity = decisions.reduce((sum, d) => sum + d.equityScore, 0) / decisions.length;
  document.getElementById('gameContainer').classList.add('hidden');
  document.getElementById('resultContainer').classList.remove('hidden');
  document.getElementById('finalEquity').textContent = Math.round(averageEquity);
  document.getElementById('finalRounds').textContent = totalRounds;
  document.getElementById('finalEquityPercent').textContent = Math.round(averageEquity);
  saveGameResult(totalTime, averageEquity);
}

function saveGameResult(totalTime, averageEquity) {
  const gameData = {
    game_type: 'fairness_game',
    score: Math.round(averageEquity),
    duration: totalTime,
    decisions: decisions,
    reaction_times: reactionTimes,
    raw_data: {
      averageEquityScore: averageEquity,
      averageReactionTime: reactionTimes.reduce((a, b) => a + b, 0) / reactionTimes.length,
      fairnessConsistency: 100 - (decisions.reduce((sum, d) => sum + Math.abs(d.equityScore - averageEquity), 0) / decisions.length),
      resourceUtilization: decisions.reduce((sum, d) => sum + (d.totalAllocated / d.totalResources), 0) / decisions.length
    }
  };
  fetch('{% url "games:save_game_result" %}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    },
    body: JSON.stringify(gameData)
  })
  .then(response => response.json())
  .then(data => {
    console.log('Game result saved:', data);
  })
  .catch(error => {
    console.error('Error saving game result:', error);
  });
}

document.addEventListener('DOMContentLoaded', function() {
  generateScenario();
});
</script>

{% csrf_token %}
{% endblock %} 