{% extends 'base.html' %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
    :root {
        --primary-color: #60A5FA; /* Blue 400 */
        --success-color: #34D399; /* Green 400 */
        --danger-color: #F87171; /* Red 400 */
        --warning-color: #FBBF24; /* Amber 400 */
        --background-color: #0F172A; /* Slate 900 */
        --surface-color: #1E293B; /* Slate 800 */
        --text-color: #F1F5F9; /* Slate 100 */
        --muted-text-color: #94A3B8; /* Slate 400 */
        --border-color: #334155; /* Slate 700 */
    }
    .game-body { background-color: var(--background-color); color: var(--text-color); font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 1rem; }
    .game-container { background-color: var(--surface-color); border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3); width: 100%; max-width: 800px; overflow: hidden; }
    .game-header { background-color: rgba(0,0,0,0.2); padding: 1.5rem; text-align: center; border-bottom: 1px solid var(--border-color); }
    .game-header h2 { font-size: 1.75rem; font-weight: bold; margin: 0; }
    .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; padding: 1.5rem; border-bottom: 1px solid var(--border-color); }
    .stat-card { background-color: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px; text-align: center; }
    .stat-card .value { font-size: 1.75rem; font-weight: bold; color: var(--primary-color); }
    .stat-card .label { font-size: 0.8rem; color: var(--muted-text-color); text-transform: uppercase; font-weight: 600; }
    .game-area { padding: 2rem; min-height: 350px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
    .offer-section, .response-section { width: 100%; }
    .offer-text { font-size: 1.25rem; margin-bottom: 1.5rem; }
    .slider-container { margin: 1rem 0; }
    input[type="range"] { width: 80%; }
    .game-controls { display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem; }
    .btn { padding: 0.75rem 2rem; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: all 0.2s; color: var(--text-color); display: flex; align-items: center; gap: 0.5rem; }
    #accept-btn, #submit-offer-btn { background-color: var(--success-color); }
    #reject-btn { background-color: var(--danger-color); }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); justify-content: center; align-items: center; }
    .modal-content { background-color: var(--surface-color); padding: 2.5rem; border-radius: 12px; border: 1px solid var(--border-color); max-width: 500px; width: 90%; box-shadow: 0 5px 15px rgba(0,0,0,0.5); animation: modal-pop 0.3s ease-out; text-align: center; }
    @keyframes modal-pop { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    #back-to-games-btn { position: absolute; top: 20px; left: 20px; background-color: rgba(0, 0, 0, 0.3); color: var(--text-color); padding: 0.5rem 1rem; border-radius: 8px; text-decoration: none; font-weight: bold; z-index: 10; }
</style>

<div class="game-body" data-game-list-url="{% url 'games:game_list' %}" data-csrf-token="{{ csrf_token }}">
    <a href="#" id="back-to-games-btn"><i class="fas fa-arrow-left"></i> Back to Games</a>

    <div class="game-container">
        <div class="game-header"><h2>Economic Fairness Challenge</h2></div>
        <div class="dashboard">
            <div class="stat-card"><div id="total-winnings" class="value">$0</div><div class="label">Your Winnings</div></div>
            <div class="stat-card"><div id="partner-type" class="value">-</div><div class="label">Partner Profile</div></div>
            <div class="stat-card"><div id="round-counter" class="value">-</div><div class="label">Round</div></div>
        </div>

        <div class="game-area">
            <div id="proposer-view" style="display: none;">
                <p class="offer-text">You have <strong>$10</strong>. How much will you offer to your partner?</p>
                <div class="slider-container">
                    <input type="range" id="offer-slider" min="0" max="10" step="1" value="5">
                    <p>Your Offer: <strong id="offer-amount">$5</strong></p>
                </div>
                <div class="game-controls"><button id="submit-offer-btn" class="btn">Submit Offer</button></div>
            </div>

            <div id="responder-view" style="display: none;">
                <p class="offer-text">Your partner has offered you <strong id="received-offer">$0</strong> out of $10.</p>
                <div class="game-controls">
                    <button id="accept-btn" class="btn"><i class="fas fa-check"></i> Accept</button>
                    <button id="reject-btn" class="btn"><i class="fas fa-times"></i> Reject</button>
                </div>
            </div>

            <div id="round-result-view" style="display: none;">
                <p id="round-result-text" style="font-size: 1.25rem;"></p>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="instruction-modal" class="modal" style="display: flex;">
        <div class="modal-content">
            <h3 style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color);">Welcome to the Economic Fairness Challenge!</h3>
            <p style="margin: 1rem 0;">You will play 15 rounds with a partner. In each round, one of you will be the Proposer and the other the Responder. The Proposer offers a split of $10. If the Responder accepts, you both get the money. If they reject, you both get nothing. Your partner's behavior may change. Your goal is to maximize your earnings.</p>
            <button id="start-game-btn" class="btn">Start Challenge</button>
        </div>
    </div>
    <div id="final-results-modal" class="modal">
        <div class="modal-content">
            <h3 style="font-size: 1.5rem; font-weight: bold;">Challenge Complete!</h3>
            <div id="final-summary" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem 1rem; text-align: left; margin: 1.5rem auto; width: fit-content;"></div>
            <button id="return-to-games-final-btn" class="btn">Return to Games</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- CONFIGURATION ---
    const GAME_ID = 'fairness_game';
    const TOTAL_ROUNDS = 15;
    const PARTNER_PROFILES = {
        FAIR: { name: 'Consistent', rejection_threshold: 3 }, // Rejects offers < $3
        UNFAIR: { name: 'Demanding', rejection_threshold: 5 }, // Rejects offers < $5
        STRATEGIC: { name: 'Pragmatic', rejection_threshold: 1 }, // Accepts almost anything
    };

    // --- DOM Elements ---
    const gameBody = document.querySelector('.game-body');
    const { proposerView, responderView, roundResultView, instructionModal, finalResultsModal } = {
        proposerView: document.getElementById('proposer-view'),
        responderView: document.getElementById('responder-view'),
        roundResultView: document.getElementById('round-result-view'),
        instructionModal: document.getElementById('instruction-modal'),
        finalResultsModal: document.getElementById('final-results-modal'),
    };
    const { totalWinningsEl, partnerTypeEl, roundCounterEl, offerSlider, offerAmountEl, receivedOfferEl } = {
        totalWinningsEl: document.getElementById('total-winnings'),
        partnerTypeEl: document.getElementById('partner-type'),
        roundCounterEl: document.getElementById('round-counter'),
        offerSlider: document.getElementById('offer-slider'),
        offerAmountEl: document.getElementById('offer-amount'),
        receivedOfferEl: document.getElementById('received-offer'),
    };
    const { startGameBtn, submitOfferBtn, acceptBtn, rejectBtn, backToGamesBtn, returnToGamesFinalBtn } = {
        startGameBtn: document.getElementById('start-game-btn'),
        submitOfferBtn: document.getElementById('submit-offer-btn'),
        acceptBtn: document.getElementById('accept-btn'),
        rejectBtn: document.getElementById('reject-btn'),
        backToGamesBtn: document.getElementById('back-to-games-btn'),
        returnToGamesFinalBtn: document.getElementById('return-to-games-final-btn'),
    };

    // --- GAME STATE ---
    let state = {};
    const resetState = () => {
        state = {
            gameStartTime: 0,
            currentRound: 0,
            totalWinnings: 0,
            partnerProfile: null,
            currentRole: null,
            currentOffer: 0,
            events: [],
            gameCompleted: false,
            isSaving: false,
        };
    };

    // --- Core Game Logic ---
    const startGame = async () => {
        resetState();
        state.gameStartTime = Date.now();
        instructionModal.style.display = 'none';
        logEvent('game_start');
        startRound();
    };

    const startRound = async () => {
        state.currentRound++;
        if (state.currentRound > TOTAL_ROUNDS) {
            await endGame(true);
            return;
        }
        // Change partner profile every 5 rounds
        if (state.currentRound === 6) state.partnerProfile = PARTNER_PROFILES.UNFAIR;
        if (state.currentRound === 11) state.partnerProfile = PARTNER_PROFILES.STRATEGIC;

        state.roundStartTime = Date.now();
        updateDashboard();
        const isProposer = Math.random() < 0.5;
        logEvent('round_start', { role: isProposer ? 'proposer' : 'responder', partner_profile: state.partnerProfile.name });

        if (isProposer) {
            showView(proposerView);
        } else {
            const partnerOffer = generatePartnerOffer();
            receivedOfferEl.textContent = `$${partnerOffer}`;
            logEvent('offer_received', { offer: partnerOffer });
            showView(responderView);
        }
    };

    const generatePartnerOffer = () => {
        // Partner AI logic
        switch(state.partnerProfile.name) {
            case 'Consistent': return Math.random() < 0.8 ? 5 : 4; // Mostly fair
            case 'Demanding': return Math.random() < 0.8 ? 2 : 3; // Mostly unfair
            case 'Pragmatic': return Math.floor(Math.random() * 5) + 1; // Random low offers
            default: return 5;
        }
    };

    const handleOfferSubmit = () => {
        const offer = parseInt(offerSlider.value);
        const reactionTime = Date.now() - state.roundStartTime;
        logEvent('offer_made', { offer: offer, reaction_time: reactionTime });

        const accepted = offer >= state.partnerProfile.rejection_threshold;
        const earnings = accepted ? 10 - offer : 0;
        state.totalWinnings += earnings;

        logEvent('round_end', { result: accepted ? 'accepted' : 'rejected', earnings: earnings });
        showRoundResult(`Your partner ${accepted ? 'accepted' : 'rejected'} your offer of $${offer}. You earned $${earnings}.`);
    };

    const handleResponse = (accepted) => {
        const offer = parseInt(receivedOfferEl.textContent.slice(1));
        const reactionTime = Date.now() - state.roundStartTime;
        logEvent('response_made', { offer: offer, response: accepted ? 'accepted' : 'rejected', reaction_time: reactionTime });

        const earnings = accepted ? offer : 0;
        state.totalWinnings += earnings;

        logEvent('round_end', { result: accepted ? 'accepted' : 'rejected', earnings: earnings });
        showRoundResult(`You ${accepted ? 'accepted' : 'rejected'} the offer of $${offer}. You earned $${earnings}.`);
    };

    const showRoundResult = (text) => {
        document.getElementById('round-result-text').textContent = text;
        showView(roundResultView);
        setTimeout(() => {
            showView(null); // Hide all views
            startRound();
        }, 2500);
    };

    const endGame = async (completed) => {
        if (state.gameCompleted) return;
        state.gameCompleted = completed;
        logEvent(completed ? 'game_completed' : 'game_abandoned');
        await displayFinalResults(); // Now awaits the results display and save
    };

    // --- UI & Helpers ---
    const updateDashboard = () => {
        totalWinningsEl.textContent = `$${state.totalWinnings}`;
        partnerTypeEl.textContent = state.partnerProfile.name;
        roundCounterEl.textContent = `${state.currentRound}/${TOTAL_ROUNDS}`;
    };

    const showView = (viewToShow) => {
        [proposerView, responderView, roundResultView].forEach(v => v.style.display = 'none');
        if (viewToShow) viewToShow.style.display = 'block';
    };

    const displayFinalResults = async () => {
        // Save data first to prevent race conditions
        await sendDataToBackend();

        const offersMade = state.events.filter(e => e.type === 'offer_made').map(e => e.offer);
        const offersReceived = state.events.filter(e => e.type === 'offer_received').map(e => e.offer);
        const acceptedCount = state.events.filter(e => e.type === 'response_made' && e.response === 'accepted').length;
        const rejectedCount = state.events.filter(e => e.type === 'response_made' && e.response === 'rejected').length;

        document.getElementById('final-summary').innerHTML = `
            <div><strong>Total Winnings:</strong></div><div style="color: var(--success-color); font-weight: bold;">$${state.totalWinnings}</div>
            <div><strong>Avg. Offer Made:</strong></div><div>$${(offersMade.reduce((a, b) => a + b, 0) / (offersMade.length || 1)).toFixed(2)}</div>
            <div><strong>Avg. Offer Received:</strong></div><div>$${(offersReceived.reduce((a, b) => a + b, 0) / (offersReceived.length || 1)).toFixed(2)}</div>
            <div><strong>Offers Accepted:</strong></div><div>${acceptedCount}</div>
            <div><strong>Offers Rejected:</strong></div><div>${rejectedCount}</div>
        `;
        // Show modal only after data is saved
        finalResultsModal.style.display = 'flex';
    };

    // --- Data Handling ---
    const logEvent = (type, details = {}) => {
        state.events.push({ type, round: state.currentRound, timestamp: Date.now() - state.gameStartTime, ...details });
    };

    const sendDataToBackend = async () => {
        if (state.isSaving) return;
        state.isSaving = true;

        try {
            const completionStatus = state.gameCompleted ? 'completed' : 'abandoned';
            const data = {
                game_name: GAME_ID,
                score: state.totalWinnings,
                duration_ms: Date.now() - state.gameStartTime,
                completion_status: completionStatus,
                events: state.events,
                game_specific_data: { total_winnings: state.totalWinnings }
            };

            const response = await fetch('{% url "games:save_score" %}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': gameBody.dataset.csrfToken },
                body: JSON.stringify(data),
            });
            if (!response.ok) throw new Error('Server error');
            return await response.json();
        } catch (error) {
            console.error('Error saving data:', error);
        } finally {
            state.isSaving = false;
        }
    };

    const quitGame = async () => {
        if (state.isSaving || state.gameStartTime === 0) return;
        state.gameCompleted = false;
        await sendDataToBackend();
    };

    // --- Event Listeners ---
    const handleExit = async (e) => {
        e.preventDefault();
        if (state.isSaving) return;

        if (state.gameStartTime !== 0 && !state.gameCompleted) {
            await quitGame();
        }

        window.location.href = gameBody.dataset.gameListUrl;
    };

    startGameBtn.addEventListener('click', startGame);
    offerSlider.addEventListener('input', (e) => offerAmountEl.textContent = `$${e.target.value}`);
    submitOfferBtn.addEventListener('click', handleOfferSubmit);
    acceptBtn.addEventListener('click', () => handleResponse(true));
    rejectBtn.addEventListener('click', () => handleResponse(false));
    backToGamesBtn.addEventListener('click', handleExit);
    returnToGamesFinalBtn.addEventListener('click', handleExit);
});
</script>
{% endblock %}
